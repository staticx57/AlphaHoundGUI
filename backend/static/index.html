<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RadTrace - Gamma Spectroscopy Analysis</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/style.css?v=6">
    <link rel="stylesheet" href="/static/button-fixes.css?v=2">
    <link rel="icon" type="image/svg+xml" href="/static/icons/favicon.svg">
    <!-- Chart.js loaded async for performance -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"
        defer></script>
</head>

<body>
    <header>
        <h1><img src="/static/icons/rocket.svg" class="icon icon-xl" style="margin-right:0.5rem;">RadTrace</h1>
        <div class="header-controls">
            <button id="btn-history" title="File History"><img src="/static/icons/history.svg" class="icon">
                History</button>
            <button id="btn-settings" title="Analysis Settings"><img src="/static/icons/settings.svg" class="icon">
                Settings</button>
            <button id="btn-theme" title="Toggle Light/Dark Mode"><img src="/static/icons/theme.svg"
                    class="icon"></button>
        </div>
    </header>



    <main>
        <!-- AlphaHound Device Quick Connect -->
        <div id="device-quick-panel"
            style="background: var(--card-bg); border: 2px solid var(--accent-color); border-radius: 12px; padding: 1rem; margin-bottom: 1.5rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
            <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;">
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <img src="/static/icons/device.svg" class="icon icon-xl" alt="Device">
                    <h3 style="margin: 0; color: var(--accent-color);">AlphaHound Device</h3>
                </div>

                <div style="flex: 1; display: flex; gap: 0.5rem; align-items: center; min-width: 300px;">
                    <select id="port-select"
                        style="flex: 1; padding: 0.5rem; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-color);">
                        <option value="">Select Serial Port...</option>
                    </select>
                    <button id="btn-refresh-ports"
                        style="padding: 0.5rem 1rem; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer;"><img
                            src="/static/icons/refresh.svg" class="icon" style="margin:0;"></button>
                </div>

                <div style="display: flex; gap: 0.5rem;">
                    <button id="btn-connect-device" class="btn-primary"
                        style="padding: 0.5rem 1.5rem; background: var(--accent-color); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">Connect</button>
                </div>
            </div>

            <div id="device-connected" class="device-panel-grid"
                style="display: none; border-top: 1px solid var(--border-color); margin-top: 0.75rem; padding-top: 0.75rem;">
                <!-- Left: Controls -->
                <div class="device-controls" style="padding-bottom: 0.5rem;">
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
                        <span style="color: #10b981; font-size: 1.2rem;">●</span>
                        <span style="color: var(--text-secondary); font-weight: 500;">Connected</span>
                        <span id="acquisition-server-status"
                            style="display: none; margin-left: 0.5rem; padding: 2px 8px; background: var(--accent-color); color: white; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">
                            SERVER-MANAGED
                        </span>
                    </div>

                    <div style="display: flex; gap: 0.75rem; align-items: center; flex-wrap: wrap;">
                        <!-- Duration Input Group -->
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <label for="count-time"
                                style="color: var(--text-secondary); font-size: 0.875rem;">Duration:</label>
                            <input type="number" id="count-time" value="5" min="0.1" max="1440" step="0.5"
                                style="width: 60px; padding: 0.25rem 0.5rem; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 4px; color: var(--text-color);">
                            <span style="color: var(--text-secondary); font-size: 0.875rem;">min</span>
                        </div>

                        <!-- Acquire/Stop Actions -->
                        <button id="btn-start-acquire" class="btn-primary"
                            style="padding: 0.4rem 0.8rem; font-size: 0.9rem;">
                            <img src="/static/icons/play.svg" class="icon"> Acquire
                        </button>
                        <button id="btn-stop-acquire" class="btn-stop"
                            style="display: none; padding: 0.4rem 0.8rem; font-size: 0.9rem; background: #f59e0b; color: white; border: none; border-radius: 6px;">
                            <img src="/static/icons/stop.svg" class="icon"> Stop
                        </button>

                        <!-- Get Current Spectrum (cumulative from device) -->
                        <button id="btn-get-current" class="btn-secondary"
                            style="padding: 0.4rem 0.8rem; font-size: 0.9rem; background: var(--card-bg); border: 1px solid var(--accent-color); color: var(--accent-color);"
                            title="Download current cumulative spectrum from device without clearing">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                                style="vertical-align: middle; margin-right: 4px;">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                                <polyline points="7 10 12 15 17 10" />
                                <line x1="12" y1="15" x2="12" y2="3" />
                            </svg> Get Current
                        </button>

                        <!-- Clear Spectrum -->
                        <button id="btn-clear-spectrum" class="btn-secondary"
                            style="padding: 0.4rem 0.8rem; font-size: 0.9rem; background: var(--card-bg); border: 1px solid #f59e0b; color: #f59e0b;"
                            title="Clear/reset spectrum on device (W command)">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                                style="vertical-align: middle; margin-right: 4px;">
                                <polyline points="3 6 5 6 21 6" />
                                <path
                                    d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" />
                            </svg> Clear
                        </button>

                        <!-- Display Mode Controls -->
                        <div
                            style="display: flex; gap: 0.25rem; border: 1px solid var(--border-color); border-radius: 6px; padding: 2px;">
                            <button id="btn-display-prev" class="btn-secondary"
                                style="padding: 0.25rem 0.5rem; font-size: 0.8rem; background: var(--card-bg); border: none; border-radius: 4px;"
                                title="Previous display mode (Q command)">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M15 18l-6-6 6-6" />
                                </svg>
                            </button>
                            <span
                                style="padding: 0.25rem 0.4rem; font-size: 0.75rem; color: var(--text-secondary);">Display</span>
                            <button id="btn-display-next" class="btn-secondary"
                                style="padding: 0.25rem 0.5rem; font-size: 0.8rem; background: var(--card-bg); border: none; border-radius: 4px;"
                                title="Next display mode (E command)">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M9 6l6 6-6 6" />
                                </svg>
                            </button>
                        </div>

                        <!-- Timer Box -->
                        <div id="acquisition-status"
                            style="display: none; padding: 0.4rem 0.8rem; background: var(--bg-secondary); border: 1px solid var(--accent-color); border-radius: 6px; font-size: 0.9rem; white-space: nowrap;">
                            <span
                                style="color: var(--accent-color); font-weight: 600; font-variant-numeric: tabular-nums;">
                                <span id="acquisition-timer">0s</span>
                            </span>
                        </div>

                        <!-- Disconnect Action -->
                        <button id="btn-disconnect-device"
                            style="padding: 0.4rem 0.8rem; background: #ef4444; color: white; border: none; border-radius: 6px; font-size: 0.9rem; margin-left: auto;">
                            Disconnect
                        </button>
                    </div>

                    <!-- Server-managed acquisition info -->
                    <div id="server-acquisition-info"
                        style="display: none; margin-top: 0.5rem; font-size: 0.8rem; color: var(--text-secondary); padding: 0.5rem; background: rgba(56, 189, 248, 0.1); border-radius: 4px;">
                        <span style="color: var(--accent-color);">ℹ</span> Acquisition managed server-side. You can
                        close this tab and it will continue.
                    </div>
                </div>

                <!-- Right: Chart & Data -->
                <div class="device-live-data"
                    style="background: var(--bg-secondary); border-radius: 8px; padding: 0.5rem 1rem; display: flex; flex-direction: column; justify-content: center; position: relative; min-height: 80px;">
                    <div
                        style="display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 0px;">
                        <span
                            style="color: var(--text-secondary); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em;">LATEST
                            DOSE RATE</span>
                        <div style="display: flex; gap: 1rem; align-items: baseline;">
                            <span id="dose-display"
                                style="font-size: 1.25rem; font-weight: 700; color: var(--accent-color);">--</span>
                            <span id="temp-display"
                                style="font-size: 0.9rem; color: var(--text-secondary); display: none;"
                                title="Device Temperature"><svg width="14" height="14" viewBox="0 0 24 24" fill="none"
                                    stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round" style="vertical-align: middle; margin-right: 2px;">
                                    <path d="M14 14.76V3.5a2.5 2.5 0 0 0-5 0v11.26a4.5 4.5 0 1 0 5 0z" />
                                </svg> --°C</span>
                        </div>
                    </div>
                    <div class="sparkline-container" style="flex: 1; min-height: 50px; position: relative;">
                        <canvas id="doseRateChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="upload-container" id="drop-zone">
            <div class="upload-icon"><img src="/static/icons/upload.svg" style="width: 64px; height: 64px;"></div>
            <h2>Drop your N42 or CSV file here</h2>
            <p>or click to browse</p>
            <input type="file" id="file-input" accept=".n42,.xml,.csv">
        </div>

        <div id="dashboard" style="display: none;">
            <div class="metadata-panel" id="metadata-panel">
                <!-- Populated by JS -->
            </div>

            <div class="controls">
                <button id="btn-lin" class="active">Linear</button>
                <button id="btn-log">Logarithmic</button>
                <button id="btn-reset-zoom">Reset Zoom</button>
                <button id="btn-auto-scale" class="active"
                    title="Toggle between Auto-Scale (zoom to data) and Full Spectrum view">Auto-Scale</button>
                <button id="btn-export-json">Export JSON</button>
                <button id="btn-export-csv">Export CSV</button>
                <button id="btn-export-pdf" class="btn-accent"><img src="/static/icons/pdf.svg" class="icon"> Export
                    PDF</button>
                <button id="btn-export-n42" class="btn-accent"><img src="/static/icons/upload.svg" class="icon"> Export
                    N42</button>
                <button id="btn-compare" title="Compare Mode"><img src="/static/icons/compare.svg" class="icon">
                    Compare</button>
                <button id="btn-analysis" title="Advanced Analysis"><img src="/static/icons/analysis.svg" class="icon">
                    Analysis</button>
            </div>

            <div id="compare-panel" style="display: none;" class="compare-panel">
                <strong>Comparison Mode:</strong>
                <span id="overlay-count">0 spectra loaded</span>
                <button id="btn-add-file">+ Add Spectrum</button>
                <button id="btn-clear-overlays">Clear All</button>
                <input type="file" id="compare-file-input" accept=".n42,.xml,.csv" style="display:none;">
            </div>

            <div id="analysis-panel" style="display: none;" class="compare-panel">
                <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                    <strong>Spectral Analysis</strong>
                    <div style="display: flex; gap: 8px;">
                        <button id="btn-decay-tool" class="btn-primary"
                            style="padding: 4px 12px; font-size: 0.8rem; background: var(--bg-secondary); border: 1px solid var(--accent-color); color: var(--accent-color);">
                            ⏳ Decay Prediction</button>
                        <button id="btn-ml-identify" class="btn-primary"
                            style="padding: 4px 12px; font-size: 0.8rem;"><img src="/static/icons/robot.svg"
                                class="icon" style="margin-right: 0.25rem;">AI Identify</button>
                        <button id="btn-run-fit" class="btn-primary" style="padding: 4px 8px; font-size: 0.8rem;">Run
                            Peak
                            Fitting</button>
                    </div>
                </div>
                <div id="analysis-results" style="margin-top: 10px; width: 100%; overflow-x: auto;">
                    <p style="color: #94a3b8; font-size: 0.9rem;">Click "Run Peak Fitting" to calculate FWHM and Net
                        Area.</p>
                </div>

                <div id="calibration-section"
                    style="margin-top: 1rem; border-top: 1px solid var(--border-color); padding-top: 1rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <strong>Calibration</strong>
                    </div>
                    <div style="margin-top: 0.5rem;">
                        <button id="btn-calibrate-mode" style="font-size: 0.85rem; padding: 4px 8px;">Open
                            Calibration
                            Tool</button>
                    </div>
                </div>

                <div id="background-section"
                    style="margin-top: 1rem; border-top: 1px solid var(--border-color); padding-top: 1rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <strong>Background Subtraction</strong>
                        <span id="bg-active-indicator"
                            style="display:none; color: var(--accent-color); font-size: 0.8rem; font-weight: bold;">●
                            Active</span>
                    </div>
                    <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem; flex-wrap: wrap;">
                        <button id="btn-snip-bg" class="btn-primary" style="font-size: 0.85rem; padding: 4px 8px;"
                            title="Auto-remove Compton continuum using SNIP algorithm"><svg width="14" height="14"
                                viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                stroke-linecap="round" stroke-linejoin="round"
                                style="vertical-align: middle; margin-right: 4px;">
                                <polyline points="6 9 12 15 18 9" />
                            </svg> Auto Remove BG</button>
                        <button id="btn-load-bg" style="font-size: 0.85rem; padding: 4px 8px;">Load Background
                            File</button>
                        <button id="btn-set-current-bg" style="font-size: 0.85rem; padding: 4px 8px;">Use Current as
                            BG</button>
                        <button id="btn-clear-bg"
                            style="font-size: 0.85rem; padding: 4px 8px; background: #ef4444; color: white; border: none; display:none;">Clear
                            BG</button>
                    </div>
                    <div id="bg-status"
                        style="margin-top: 0.5rem; font-size: 0.8rem; color: var(--text-secondary); font-style: italic;">
                        No background loaded.
                    </div>
                    <input type="file" id="bg-file-input" accept=".n42,.xml,.csv" style="display:none;">
                </div>
            </div>

            <div class="chart-container">
                <canvas id="spectrumChart"></canvas>
            </div>

            <!-- Scrubby Zoom Slider -->
            <div id="zoom-scrubber" class="zoom-scrubber-container" style="display: none;">
                <div class="zoom-scrubber-track">
                    <canvas id="scrubber-preview" class="scrubber-preview"></canvas>
                    <div id="scrubber-selection" class="scrubber-selection"></div>
                </div>
                <div class="zoom-scrubber-controls">
                    <input type="range" id="zoom-min" class="zoom-handle zoom-handle-min" min="0" max="100" value="0"
                        step="0.1">
                    <input type="range" id="zoom-max" class="zoom-handle zoom-handle-max" min="0" max="100" value="100"
                        step="0.1">
                </div>
                <div class="zoom-scrubber-labels">
                    <span id="zoom-min-label">0 keV</span>
                    <span style="flex: 1;"></span>
                    <span id="zoom-max-label">3000 keV</span>
                </div>
            </div>

            <div id="peaks-container" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                    <h3 style="margin: 0;">Detected Peaks</h3>
                    <button id="btn-toggle-peaks" class="btn-secondary"
                        style="font-size: 0.8rem; padding: 2px 8px;">Hide</button>
                </div>
                <div id="peaks-scroll-area" class="scrollable-table-area">
                    <table id="peaks-table" class="data-table">
                        <thead>
                            <tr>
                                <th>Energy (keV)</th>
                                <th class="text-right">Counts</th>
                            </tr>
                        </thead>
                        <tbody id="peaks-tbody"></tbody>
                    </table>
                </div>
            </div>

            <div id="isotopes-container" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h3 style="margin: 0;"><img src="/static/icons/analysis.svg" class="icon"> Isotope
                        Identification
                    </h3>
                    <div style="display: flex; gap: 0.5rem;">
                        <button id="btn-run-ml" class="btn-primary"
                            style="padding: 6px 12px; font-size: 0.85rem; display: flex; align-items: center; gap: 4px;">
                            <img src="/static/icons/robot.svg" class="icon" style="margin-right: 0.25rem;">AI
                            Identify
                        </button>
                    </div>
                </div>

                <!-- Dual Detection Results -->
                <div id="identification-results" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">

                    <!-- Legacy Peak-Based Results -->
                    <div class="detection-panel"
                        style="background: var(--card-bg); border-radius: 10px; padding: 1rem; border: 1px solid var(--border-color);">
                        <div
                            style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--border-color);">
                            <img src="/static/icons/chart.svg" class="icon" style="margin-right: 0.25rem;">
                            <strong style="color: var(--text-primary);">Peak Matching</strong>
                            <span
                                style="font-size: 0.75rem; color: var(--text-secondary); margin-left: auto;">Legacy</span>
                        </div>
                        <div id="legacy-isotopes-list">
                            <!-- Populated by JS -->
                        </div>
                    </div>

                    <!-- ML-Based Results -->
                    <div class="detection-panel"
                        style="background: linear-gradient(135deg, rgba(56, 189, 248, 0.1), rgba(139, 92, 246, 0.1)); border-radius: 10px; padding: 1rem; border: 1px solid var(--accent-color);">
                        <div
                            style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--accent-color);">
                            <img src="/static/icons/robot.svg" class="icon" style="margin-right: 0.25rem;">
                            <strong style="color: var(--accent-color);">AI Identification</strong>
                            <span
                                style="font-size: 0.65rem; background: orange; color: black; padding: 2px 6px; border-radius: 4px; font-weight: bold;">WIP</span>
                            <span style="font-size: 0.75rem; color: var(--text-secondary); margin-left: auto;">PyRIID
                                ML</span>
                        </div>
                        <div id="ml-isotopes-list">
                            <p style="color: var(--text-secondary); font-size: 0.875rem; font-style: italic;">Click
                                "AI
                                Identify" to run ML classification</p>
                        </div>
                    </div>
                </div>

                <!-- Info Bar -->
                <div
                    style="margin-top: 1rem; padding: 0.75rem; background: rgba(56, 189, 248, 0.1); border-radius: 8px; font-size: 0.8rem; color: var(--text-secondary);">
                    <strong><img src="/static/icons/lightbulb.svg" class="icon"
                            style="margin-right: 0.25rem; vertical-align: middle;">Tip:</strong> Peak Matching uses
                    known gamma energies
                    from IAEA/NNDC databases. AI
                    Identification uses a neural network trained on 90+ isotopes for pattern recognition.
                </div>
            </div>

            <div id="decay-chains-container" style="display: none; margin-top: 2rem;">
                <h3><img src="/static/icons/analysis.svg" class="icon"> Decay Chains Detected</h3>
                <div id="decay-chains-list">
                    <!-- Populated by JS -->
                </div>
            </div>

            <!-- ROI Analysis Panel (Advanced Mode Only) -->
            <div id="roi-analysis-panel" style="display: none;">
                <h3><img src="/static/icons/analysis.svg" class="icon"> Region-of-Interest (ROI) Analysis</h3>

                <!-- Configuration Grid -->
                <!-- Use CSS Grid for layout -->
                <style>
                    .roi-grid {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
                        gap: 1.5rem;
                        padding: 1.5rem;
                        background: var(--bg-secondary);
                        border-radius: 8px;
                        margin-bottom: 0.75rem;
                        align-items: end;
                    }

                    .roi-field {
                        display: flex;
                        flex-direction: column;
                        gap: 0.35rem;
                        font-size: 0.85rem;
                        color: var(--text-secondary);
                    }

                    .roi-field select,
                    .roi-field input {
                        padding: 0.4rem;
                        border: 1px solid var(--border-color);
                        border-radius: 4px;
                        background: var(--bg-primary);
                        color: var(--text-primary);
                        width: 100%;
                    }

                    .roi-actions {
                        display: flex;
                        gap: 0.5rem;
                        grid-column: 1 / -1;
                        padding-top: 0.5rem;
                        border-top: 1px solid var(--border-color);
                        margin-top: 0.25rem;
                    }
                </style>

                <div class="roi-grid">
                    <label class="roi-field">
                        Source Type
                        <select id="roi-source-type">
                            <option value="unknown">Standard Analysis (Default)</option>
                            <option value="uranium_glass">Uranium Glass (Vaseline)</option>
                            <option value="uranium_ore">Uranium Ore (Natural)</option>
                            <option value="thoriated_lens">Thoriated Camera Lens</option>
                            <option value="takumar_lens">Takumar Lens (Th + Natural U)</option>
                            <option value="radium_dial">Radium Dial (Watch/Clock)</option>
                            <option value="smoke_detector">Smoke Detector (Am-241)</option>
                            <option value="cesium_source">Cesium-137 Source</option>
                            <option value="cobalt_source">Cobalt-60 Source</option>
                            <option value="natural_background">Natural Background</option>
                        </select>
                    </label>

                    <label class="roi-field">
                        Detector
                        <select id="roi-detector">
                            <option value="AlphaHound CsI(Tl)">CsI(Tl) 1.1cm³</option>
                            <option value="AlphaHound BGO">BGO 0.6cm³</option>
                        </select>
                    </label>

                    <label class="roi-field">
                        Acq. Time (min)
                        <input type="number" id="roi-acq-time" value="10" min="0.1" max="1440" step="0.1">
                    </label>

                    <label class="roi-field">
                        Target Isotope
                        <select id="roi-isotope">
                            <option value="U-235 (186 keV)">U-235 (186 keV)</option>
                            <option value="Th-234 (93 keV)">Th-234 (93 keV)</option>
                            <option value="Bi-214 (609 keV)">Bi-214 (609 keV)</option>
                            <option value="Cs-137 (662 keV)">Cs-137 (662 keV)</option>
                            <option value="Co-60 (1173 keV)">Co-60 (1173 keV)</option>
                            <option value="Co-60 (1332 keV)">Co-60 (1332 keV)</option>
                            <option value="K-40 (1461 keV)">K-40 (1461 keV)</option>
                            <option value="Am-241 (60 keV)">Am-241 (60 keV)</option>
                            <option value="Tl-208 (2614 keV)">Tl-208 (2614 keV)</option>
                            <option value="Ac-228 (911 keV)">Ac-228 (911 keV)</option>
                            <option value="Pb-214 (352 keV)">Pb-214 (352 keV)</option>
                            <option value="Pa-234m (1001 keV)">Pa-234m (1001 keV)</option>
                        </select>
                    </label>

                    <div class="roi-actions">
                        <button id="btn-analyze-roi" class="btn-primary"
                            style="padding: 0.5rem 1.5rem; flex: 1;">Analyze ROI</button>
                        <button id="btn-highlight-roi" class="btn-secondary"
                            style="padding: 0.5rem 1rem;">Highlight</button>
                        <button id="btn-clear-highlight" class="btn-secondary"
                            style="padding: 0.5rem 1rem;">Clear</button>
                    </div>
                </div>

                <!-- Compact Source Info Banner -->
                <div id="roi-source-info"
                    style="display: none; padding: 0.5rem 0.75rem; background: rgba(56, 189, 248, 0.1); border-left: 3px solid var(--accent-color); border-radius: 4px; margin-bottom: 0.75rem; font-size: 0.8rem; color: var(--text-primary);">
                    <span id="roi-source-info-text"></span>
                </div>

                <!-- Results Section -->
                <div id="roi-results"
                    style="padding: 1rem; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; font-family: 'Roboto Mono', monospace; font-size: 0.85rem; line-height: 1.6; min-height: 80px;">
                    <p style="color: var(--text-secondary); font-style: italic; margin: 0;">
                        Select an isotope and click "Analyze ROI".
                    </p>
                </div>
            </div>
        </div>

        <!-- File History Modal -->
        <div id="history-modal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>File History</h3>
                    <button id="close-history" class="close-btn">✕</button>
                </div>
                <div id="history-list"></div>
            </div>
        </div>

        <!-- Settings Modal -->
        <div id="settings-modal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3><img src="/static/icons/settings.svg" class="icon"> Analysis Settings</h3>
                    <button id="close-settings" class="close-btn">✕</button>
                </div>

                <div style="margin: 1.5rem 0;">
                    <h4 style="margin-bottom: 1rem;">UI Complexity Mode</h4>
                    <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
                        <label
                            style="cursor: pointer; padding: 0.5rem 1rem; border: 2px solid var(--border-color); border-radius: 6px; transition: all 0.3s;">
                            <input type="radio" name="ui-mode" value="simple" checked style="margin-right: 0.5rem;">
                            <strong>Simple</strong>
                        </label>
                        <label
                            style="cursor: pointer; padding: 0.5rem 1rem; border: 2px solid var(--border-color); border-radius: 6px; transition: all 0.3s;">
                            <input type="radio" name="ui-mode" value="advanced" style="margin-right: 0.5rem;">
                            <strong>Advanced</strong>
                        </label>
                        <label
                            style="cursor: pointer; padding: 0.5rem 1rem; border: 2px solid var(--border-color); border-radius: 6px; transition: all 0.3s;">
                            <input type="radio" name="ui-mode" value="expert" style="margin-right: 0.5rem;">
                            <strong>Expert</strong>
                        </label>
                    </div>
                    <p style="margin-top: 0.5rem; color: var(--text-secondary); font-size: 0.8rem;">
                        <strong>Simple:</strong> Chart + Peaks + Isotopes only |
                        <strong>Advanced:</strong> + ROI, BG, Calibration |
                        <strong>Expert:</strong> + All analysis tools
                    </p>
                </div>

                <div style="margin: 1.5rem 0;">
                    <h4 style="margin-bottom: 1rem;">Threshold Presets</h4>
                    <div style="display: flex; gap: 1rem;">
                        <label
                            style="cursor: pointer; padding: 0.5rem 1rem; border: 2px solid var(--border-color); border-radius: 6px; transition: all 0.3s;">
                            <input type="radio" name="analysis-mode" value="simple" checked
                                style="margin-right: 0.5rem;">
                            <strong>Optimized</strong> (Recommended)
                        </label>
                        <label
                            style="cursor: pointer; padding: 0.5rem 1rem; border: 2px solid var(--border-color); border-radius: 6px; transition: all 0.3s;">
                            <input type="radio" name="analysis-mode" value="advanced" style="margin-right: 0.5rem;">
                            <strong>Custom</strong> (Edit below)
                        </label>
                    </div>
                    <p style="margin-top: 0.5rem; color: var(--text-secondary); font-size: 0.875rem;">Optimized uses
                        tuned defaults for hobby-level sources. Custom unlocks threshold sliders.</p>
                </div>

                <div id="advanced-settings"
                    style="display: none; margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color);">
                    <h4 style="margin-bottom: 1rem;">Detection Thresholds</h4>

                    <div style="margin-bottom: 1.5rem;">
                        <label
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <span>Isotope Min Confidence:</span>
                            <strong><span id="iso-conf-val">40</span>%</strong>
                        </label>
                        <input type="range" id="isotope-confidence" min="10" max="90" value="40" step="5"
                            style="width: 100%;">
                        <p style="color: var(--text-secondary); font-size: 0.75rem; margin-top: 0.25rem;">Minimum %
                            of
                            characteristic peaks required to report an isotope</p>
                    </div>

                    <div style="margin-bottom: 1.5rem;">
                        <label
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <span>Chain Min Confidence:</span>
                            <strong><span id="chain-conf-val">30</span>%</strong>
                        </label>
                        <input type="range" id="chain-confidence" min="10" max="90" value="30" step="5"
                            style="width: 100%;">
                        <p style="color: var(--text-secondary); font-size: 0.75rem; margin-top: 0.25rem;">Minimum
                            confidence to report a decay chain</p>
                    </div>

                    <div style="margin-bottom: 1.5rem;">
                        <label
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <span>Energy Tolerance:</span>
                            <strong><span id="energy-tol-val">20</span> keV</strong>
                        </label>
                        <input type="range" id="energy-tolerance" min="5" max="50" value="20" step="1"
                            style="width: 100%;">
                        <p style="color: var(--text-secondary); font-size: 0.75rem; margin-top: 0.25rem;">Maximum
                            energy
                            difference for peak matching</p>
                    </div>

                    <button id="btn-reset-defaults"
                        style="padding: 0.5rem 1rem; border-radius: 6px; margin-right: 0.5rem;">Reset to
                        Defaults</button>
                </div>

                <div
                    style="text-align: right; margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color); display:flex; justify-content:space-between; align-items:center;">
                    <button id="btn-manage-isotopes"
                        style="background:transparent; border:1px solid var(--border-color); color:var(--text-primary);">Manage
                        Custom Isotopes</button>
                    <button id="btn-apply-settings" class="btn-primary">Apply Settings</button>
                </div>
            </div>
        </div>


        <!-- Calibration Modal -->
        <div id="calibration-modal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Energy Calibration</h3>
                    <button id="close-calibration" class="close-btn">✕</button>
                </div>
                <div style="margin: 1rem 0;">
                    <p>Click on the chart to add points (Channel), then enter the known energy.</p>
                    <table style="width: 100%; text-align: left; margin-bottom: 1rem;">
                        <thead>
                            <tr>
                                <th>Channel</th>
                                <th>Energy (keV)</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="cal-points-tbody"></tbody>
                    </table>
                    <div id="cal-results"
                        style="display:none; background: #f0fdf4; padding: 0.5rem; border-radius: 6px; margin-bottom: 1rem; border: 1px solid #86efac;">
                        <strong>Fit Results:</strong><br>
                        Slope: <span id="cal-slope"></span><br>
                        Intercept: <span id="cal-intercept"></span>
                    </div>
                    <div style="text-align: right;">
                        <button id="btn-cal-calculate">Calculate Fit</button>
                        <button id="btn-cal-apply" class="btn-primary" style="display:none;">Apply to View</button>
                    </div>
                </div>
            </div>
        </div>
        <!-- Custom Isotopes Modal -->
        <div id="isotopes-modal" class="modal" style="display: none; z-index: 1100;">
            <div class="modal-content" style="max-width: 650px;">
                <div class="modal-header">
                    <h3>Custom Isotopes</h3>
                    <button id="close-isotopes" class="close-btn">✕</button>
                </div>

                <!-- Add Isotope Form -->
                <div style="margin-bottom: 1.5rem;">
                    <form id="add-isotope-form"
                        style="display: grid; grid-template-columns: 1fr 2fr auto; gap: 12px; align-items: end;">
                        <div>
                            <label
                                style="display: block; font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 6px;">Name</label>
                            <input type="text" id="iso-name" placeholder="MySource" required
                                style="width: 100%; padding: 10px; height: 42px; box-sizing: border-box;">
                        </div>
                        <div>
                            <label
                                style="display: block; font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 6px;">Energies
                                (keV)</label>
                            <input type="text" id="iso-energies" placeholder="e.g. 662, 32" required
                                style="width: 100%; padding: 10px; height: 42px; box-sizing: border-box;">
                        </div>
                        <button type="submit" class="btn-primary"
                            style="padding: 10px 20px; height: 42px; white-space: nowrap;">Add</button>
                    </form>
                </div>

                <!-- Isotopes List -->
                <div style="margin-bottom: 1.5rem;">
                    <h4
                        style="border-bottom: 1px solid var(--border-color); padding-bottom: 8px; margin-bottom: 12px; font-size: 1rem;">
                        Your Isotopes
                    </h4>
                    <div id="custom-isotopes-list"
                        style="min-height: 60px; max-height: 200px; overflow-y: auto; padding: 8px; background: var(--bg-primary); border-radius: 6px;">
                    </div>
                </div>

                <!-- Import/Export Buttons -->
                <div style="display: flex; gap: 10px; padding-top: 1rem; border-top: 1px solid var(--border-color);">
                    <button id="btn-import-isotopes" class="btn-secondary"
                        style="flex: 1; padding: 10px 16px; display: flex; align-items: center; justify-content: center; gap: 8px;">
                        <img src="/static/icons/import.svg" style="width: 18px; height: 18px;" alt="">
                        Import JSON
                    </button>
                    <button id="btn-export-isotopes" class="btn-secondary"
                        style="flex: 1; padding: 10px 16px; display: flex; align-items: center; justify-content: center; gap: 8px;">
                        <img src="/static/icons/export.svg" style="width: 18px; height: 18px;" alt="">
                        Export JSON
                    </button>
                </div>
            </div>
        </div>

        <!-- Decay Prediction Modal -->
        <div id="decay-modal" class="modal" style="display: none; z-index: 1200;">
            <div class="modal-content" style="max-width: 800px;">
                <div class="modal-header">
                    <h3>Radioactive Decay Prediction</h3>
                    <button id="close-decay" class="close-btn">✕</button>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                    <div>
                        <label style="display: block; font-size: 0.8rem; color: var(--text-secondary);">Parent
                            Isotope</label>
                        <select id="decay-isotope"
                            style="width: 100%; padding: 0.5rem; background: var(--bg-secondary); color: var(--text-color); border: 1px solid var(--border-color); border-radius: 4px;">
                            <option value="U-238">Uranium-238 Chain (U -> Pb)</option>
                            <option value="Th-232">Thorium-232 Chain (Th -> Pb)</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; font-size: 0.8rem; color: var(--text-secondary);">Initial Activity
                            (Bq)</label>
                        <input type="number" id="decay-activity" value="1000" min="1"
                            style="width: 100%; padding: 0.5rem; background: var(--bg-secondary); color: var(--text-color); border: 1px solid var(--border-color); border-radius: 4px;">
                    </div>
                    <div>
                        <label style="display: block; font-size: 0.8rem; color: var(--text-secondary);">Duration
                            (Years)</label>
                        <input type="number" id="decay-duration" value="1" min="0.01" max="1000000000" step="0.1"
                            style="width: 100%; padding: 0.5rem; background: var(--bg-secondary); color: var(--text-color); border: 1px solid var(--border-color); border-radius: 4px;">
                    </div>
                    <div style="display: flex; align-items: end;">
                        <button id="btn-run-decay" class="btn-primary" style="width: 100%; padding: 0.6rem;">Calculate &
                            Plot</button>
                    </div>
                </div>

                <div
                    style="background: var(--bg-primary); padding: 1rem; border-radius: 8px; height: 400px; position: relative;">
                    <canvas id="decayChart"></canvas>
                </div>
                <div style="margin-top: 0.5rem; font-size: 0.8rem; color: var(--text-secondary);">
                    * Predictions use authoritative nuclear data (Curie) or custom Bateman solver fallback.
                </div>
            </div>
        </div>

    </main>

    <!-- Main Application Logic (ES6 Modules) -->
    <script type="module" src="/static/js/main.js?v=2.6"></script>
</body>

</html>