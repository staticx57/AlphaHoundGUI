<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RadTrace - Gamma Spectroscopy Analysis</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/style.css?v=10">
    <link rel="stylesheet" href="/static/button-fixes.css?v=6">
    <link rel="icon" type="image/svg+xml" href="/static/icons/favicon.svg">
    <!-- Chart.js loaded async for performance -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"
        defer></script>
</head>

<body>
    <header>
        <h1><img src="/static/icons/rocket.svg" class="icon icon-xl" style="margin-right:0.5rem;">RadTrace</h1>
        <div class="header-controls">
            <button id="btn-upload-file" title="Upload Spectrum File">
                <img src="/static/icons/upload.svg" class="icon"> Upload
            </button>
            <button id="btn-history" title="File History"><img src="/static/icons/history.svg" class="icon">
                History</button>
            <button id="btn-settings" title="Analysis Settings"><img src="/static/icons/settings.svg" class="icon">
                Settings</button>
            <select id="theme-select" title="Select Theme" style="min-width: 140px;">
                <optgroup label="Modern">
                    <option value="dark">üåô Dark</option>
                    <option value="light">‚òÄÔ∏è Light</option>
                    <option value="scifi">üöÄ Sci-Fi</option>
                    <option value="cyberpunk">‚ö° Cyberpunk</option>
                </optgroup>
                <optgroup label="Radiation">
                    <option value="nuclear">‚ò¢Ô∏è Nuclear</option>
                    <option value="toxic">‚ò£Ô∏è Toxic</option>
                    <option value="civildefense">üõ°Ô∏è Civil Defense</option>
                </optgroup>
                <optgroup label="Lab Equipment">
                    <option value="hp">üìü HP</option>
                    <option value="tektronix">üìä Tektronix</option>
                    <option value="keithley">üî¨ Keithley</option>
                    <option value="fluke">üîß Fluke</option>
                    <option value="oscilloscope">üì∫ Oscilloscope</option>
                </optgroup>
                <optgroup label="Radiological">
                    <option value="eberline">üìª Eberline</option>
                    <option value="ludlum">‚ò¢Ô∏è Ludlum</option>
                    <option value="victoreen">üìü Victoreen</option>
                    <option value="canberra">üî¨ Canberra</option>
                </optgroup>
                <optgroup label="Retro Display">
                    <option value="nixie">üí° Nixie Tube</option>
                </optgroup>
            </select>
        </div>
    </header>



    <main>
        <div class="data-hub">
            <div class="data-hub-row">
                <!-- Device Type Selector Tabs (vertical, compact) -->
                <div id="device-type-tabs"
                    style="display: flex; flex-direction: column; gap: 4px; margin-right: 0.5rem; flex-shrink: 0;">
                    <button id="tab-alphahound" class="device-tab active"
                        style="padding: 0.4rem 0.6rem; font-size: 0.75rem; writing-mode: horizontal-tb;">
                        AlphaHound
                    </button>
                    <button id="tab-radiacode" class="device-tab"
                        style="padding: 0.4rem 0.6rem; font-size: 0.75rem; writing-mode: horizontal-tb;">
                        Radiacode
                    </button>
                </div>

                <!-- Device panels wrapper (stacks vertically) -->
                <div style="display: flex; flex-direction: column; flex: 1; gap: 0;">
                    <!-- Unified Device Panel (shows for both tabs) -->
                    <div id="device-quick-panel">
                        <!-- Device Title (simple, not in flex header) -->
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
                            <img src="/static/icons/device.svg" class="icon icon-xl" alt="Device">
                            <h3 id="device-title" style="margin: 0; color: var(--accent-color);">AlphaHound Device</h3>
                        </div>

                        <!-- Connection Controls Box (Full Width Row) -->
                        <div
                            style="border: 1px solid var(--border-color); border-radius: 8px; padding: 0.75rem; margin-bottom: 0.75rem; background: var(--bg-secondary);">

                            <!-- AlphaHound Connection Row -->
                            <div id="alphahound-connection-row"
                                style="display: flex; gap: 0.75rem; align-items: center; flex-wrap: wrap;">
                                <div style="display: flex; gap: 0.5rem; min-width: 200px;">
                                    <select id="port-select" style="min-width: 150px; width: 250px;">
                                        <option value="">Select Serial Port...</option>
                                    </select>
                                    <button id="btn-refresh-ports" title="Refresh Ports" style="flex-shrink: 0;">
                                        <img src="/static/icons/refresh.svg" class="icon" style="margin:0;">
                                    </button>
                                </div>
                                <button id="btn-connect-device" class="btn-primary"
                                    style="padding: 0.5rem 1.5rem; flex-shrink: 0;">Connect</button>
                            </div>

                            <!-- Radiacode Connection Row -->
                            <div id="radiacode-connection-row"
                                style="display: none; gap: 0.75rem; align-items: center; flex-wrap: wrap;">

                                <!-- Connection Mode -->
                                <div style="display: flex; gap: 0.5rem; align-items: center;">
                                    <label style="display: flex; align-items: center; gap: 0.25rem; cursor: pointer;">
                                        <input type="radio" name="rc-conn-mode" value="usb" checked>
                                        <span style="font-size: 0.85rem;">USB</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.25rem; cursor: pointer;">
                                        <input type="radio" name="rc-conn-mode" value="bluetooth">
                                        <span style="font-size: 0.85rem;">Bluetooth</span>
                                    </label>
                                </div>

                                <!-- BLE Scan and Device Selection (shown when Bluetooth selected) -->
                                <div id="rc-ble-controls" style="display: none; gap: 0.5rem; align-items: center;">
                                    <button id="btn-scan-ble" class="btn-secondary"
                                        style="padding: 0.4rem 0.8rem; font-size: 0.8rem;"
                                        title="Scan for nearby Radiacode devices">
                                        <img src="/static/icons/refresh.svg" class="icon"
                                            style="width: 14px; height: 14px;"> Scan
                                    </button>
                                    <select id="rc-ble-devices" style="min-width: 180px; font-size: 0.85rem;">
                                        <option value="">Select BLE Device...</option>
                                    </select>
                                    <!-- Manual MAC input fallback -->
                                    <input type="text" id="rc-bluetooth-mac" placeholder="or enter MAC"
                                        style="width: 140px; font-family: monospace; font-size: 0.8rem;"
                                        title="Manual MAC address entry">
                                </div>

                                <button id="btn-connect-radiacode" class="btn-primary"
                                    style="padding: 0.5rem 1.5rem; flex-shrink: 0;">Connect</button>

                                <!-- Disconnect Button (only shown when connected) -->
                                <button id="btn-disconnect-device"
                                    style="padding: 0.5rem 1.5rem; background: #ef4444; color: white; display: none;">
                                    Disconnect
                                </button>
                            </div>
                        </div>
                        <!-- End connection controls box -->

                        <!-- Radiacode Settings Panel -->
                        <div id="radiacode-settings-panel" data-device-feature="deviceSettings"
                            style="display: none; margin-top: 1rem;">
                            <details
                                style="background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; padding: 0.75rem;">
                                <summary
                                    style="cursor: pointer; font-weight: 700; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem; user-select: none; font-size: 0.85rem;">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2">
                                        <path
                                            d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                                    </svg>
                                    Device Settings
                                </summary>

                                <div style="margin-top: 0.75rem; display: flex; flex-direction: column; gap: 0.75rem;">
                                    <!-- Brightness -->
                                    <div style="display: flex; flex-direction: column; gap: 0.25rem;">
                                        <div
                                            style="display: flex; justify-content: space-between; align-items: center;">
                                            <label for="rc-brightness"
                                                style="font-size: 0.75rem; color: var(--text-secondary);">Brightness</label>
                                            <span id="rc-brightness-value"
                                                style="font-size: 0.75rem; font-weight: 700; color: var(--accent-color);">5</span>
                                        </div>
                                        <input type="range" id="rc-brightness" min="0" max="9" value="5"
                                            style="width: 100%; accent-color: var(--accent-color);">
                                    </div>

                                    <!-- Sound & Vibration -->
                                    <div style="display: flex; gap: 0.75rem;">
                                        <label
                                            style="display: flex; align-items: center; gap: 0.375rem; cursor: pointer; flex: 1;">
                                            <input type="checkbox" id="rc-sound"
                                                style="accent-color: var(--accent-color);">
                                            <span style="font-size: 0.75rem; color: var(--text-secondary);">Sound</span>
                                        </label>
                                        <label
                                            style="display: flex; align-items: center; gap: 0.375rem; cursor: pointer; flex: 1;">
                                            <input type="checkbox" id="rc-vibration"
                                                style="accent-color: var(--accent-color);">
                                            <span
                                                style="font-size: 0.75rem; color: var(--text-secondary);">Vibration</span>
                                        </label>
                                    </div>

                                    <!-- Timeout & Language -->
                                    <div style="display: flex; gap: 0.75rem;">
                                        <div style="flex: 1; display: flex; flex-direction: column; gap: 0.25rem;">
                                            <label for="rc-display-timeout"
                                                style="font-size: 0.75rem; color: var(--text-secondary);">Timeout
                                                (s)</label>
                                            <input type="number" id="rc-display-timeout" min="0" value="30"
                                                style="padding: 0.3rem; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 4px; color: var(--text-primary); font-size: 0.75rem;">
                                        </div>
                                        <div style="flex: 1; display: flex; flex-direction: column; gap: 0.25rem;">
                                            <label for="rc-language"
                                                style="font-size: 0.75rem; color: var(--text-secondary);">Language</label>
                                            <select id="rc-language"
                                                style="padding: 0.3rem; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 4px; color: var(--text-primary); font-size: 0.75rem;">
                                                <option value="en">EN</option>
                                                <option value="ru">RU</option>
                                            </select>
                                        </div>
                                    </div>

                                    <!-- Display Orientation & Sync Time (Phase 1) -->
                                    <div style="display: flex; gap: 0.75rem;">
                                        <div style="flex: 1; display: flex; flex-direction: column; gap: 0.25rem;"
                                            data-device-feature="displayOrientation">
                                            <label for="rc-display-direction"
                                                style="font-size: 0.75rem; color: var(--text-secondary);">Orientation</label>
                                            <select id="rc-display-direction"
                                                style="padding: 0.3rem; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 4px; color: var(--text-primary); font-size: 0.75rem;">
                                                <option value="normal">Normal</option>
                                                <option value="reversed">Reversed</option>
                                                <option value="auto">Auto</option>
                                            </select>
                                        </div>
                                        <button id="btn-sync-time" data-device-feature="timeSync" class="btn-secondary"
                                            style="padding: 0.3rem 0.6rem; font-size: 0.7rem; margin-top: auto; white-space: nowrap;">
                                            üïê Sync
                                        </button>
                                    </div>

                                    <!-- Device Info -->
                                    <div
                                        style="padding: 0.5rem; background: var(--bg-primary); border-radius: 4px; font-size: 0.7rem; color: var(--text-secondary); display: flex; flex-direction: column; gap: 0.25rem;">
                                        <div style="display: flex; gap: 0.5rem;">
                                            <span style="opacity: 0.7; min-width: 50px;">SN:</span>
                                            <span id="rc-serial-number"
                                                style="color: var(--text-primary); font-weight: 600;">--</span>
                                        </div>
                                        <div style="display: flex; gap: 0.5rem;" data-device-feature="hwSerial">
                                            <span style="opacity: 0.7; min-width: 50px;">HW SN:</span>
                                            <span id="rc-hw-serial"
                                                style="color: var(--text-primary); font-weight: 600;">--</span>
                                        </div>
                                        <div style="display: flex; gap: 0.5rem;">
                                            <span style="opacity: 0.7; min-width: 50px;">FW:</span>
                                            <span id="rc-firmware-version"
                                                style="color: var(--text-primary); font-weight: 600;">--</span>
                                        </div>
                                    </div>

                                    <!-- Energy Calibration (Phase 2) -->
                                    <details style="margin-top: 0.5rem;" data-device-feature="energyCalibration">
                                        <summary
                                            style="cursor: pointer; font-size: 0.75rem; color: var(--text-secondary);">
                                            ‚öôÔ∏è Energy Calibration
                                        </summary>
                                        <div style="margin-top: 0.5rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                            <input type="number" id="rc-cal-a0" step="0.001" placeholder="a0"
                                                style="width: 70px; font-size: 0.7rem; padding: 0.2rem;">
                                            <input type="number" id="rc-cal-a1" step="0.001" placeholder="a1"
                                                style="width: 70px; font-size: 0.7rem; padding: 0.2rem;">
                                            <input type="number" id="rc-cal-a2" step="0.00001" placeholder="a2"
                                                style="width: 70px; font-size: 0.7rem; padding: 0.2rem;">
                                            <button id="btn-get-calibration" class="btn-secondary"
                                                style="font-size: 0.65rem; padding: 0.2rem 0.4rem;">Get</button>
                                            <button id="btn-set-calibration" class="btn-primary"
                                                style="font-size: 0.65rem; padding: 0.2rem 0.4rem;">Apply</button>
                                        </div>
                                    </details>

                                    <!-- Power Off (Phase 2) -->
                                    <button id="btn-power-off" data-device-feature="powerControl" style="margin-top: 0.75rem; width: 100%; padding: 0.4rem; 
                                            background: transparent; border: 1px solid #ef4444; 
                                            color: #ef4444; border-radius: 4px; font-size: 0.75rem; cursor: pointer;">
                                        ‚èª Power Off Device
                                    </button>

                                    <!-- Advanced Info (Phase 3) -->
                                    <details style="margin-top: 0.5rem;" data-device-feature="advancedInfo">
                                        <summary
                                            style="cursor: pointer; font-size: 0.75rem; color: var(--text-secondary);">
                                            üìä Advanced Diagnostics
                                        </summary>
                                        <div
                                            style="margin-top: 0.5rem; font-size: 0.7rem; color: var(--text-secondary);">
                                            <div style="margin-bottom: 0.3rem;">
                                                <span style="opacity: 0.7;">Status:</span>
                                                <span id="rc-status-flags" style="color: var(--text-primary);">--</span>
                                            </div>
                                            <div style="margin-bottom: 0.3rem;">
                                                <span style="opacity: 0.7;">FW Sig:</span>
                                                <span id="rc-fw-signature"
                                                    style="color: var(--text-primary); word-break: break-all;">--</span>
                                            </div>
                                            <div>
                                                <span style="opacity: 0.7;">Base Time:</span>
                                                <span id="rc-base-time" style="color: var(--text-primary);">--</span>
                                            </div>
                                            <button id="btn-refresh-diagnostics" class="btn-secondary"
                                                style="margin-top: 0.4rem; font-size: 0.65rem; padding: 0.2rem 0.5rem; width: 100%;">
                                                üîÑ Refresh Diagnostics
                                            </button>
                                        </div>
                                    </details>
                                </div>
                            </details>
                        </div>
                    </div>

                    <!-- Text Message Alert Banner (Phase 3) -->
                    <div id="rc-message-banner" data-device-feature="textMessages" style="display: none; background: linear-gradient(90deg, #f59e0b22, transparent); 
                            border-left: 3px solid #f59e0b; padding: 0.5rem 0.75rem; margin-bottom: 0.5rem; 
                            border-radius: 4px; font-size: 0.8rem;">
                        <span style="font-weight: 600; color: #f59e0b;">‚ö†Ô∏è Device Alert:</span>
                        <span id="rc-message-text" style="color: var(--text-primary); margin-left: 0.25rem;">--</span>
                        <button onclick="this.parentElement.style.display='none'"
                            style="float: right; background: none; border: none; color: #f59e0b; cursor: pointer; font-size: 1rem;">√ó</button>
                    </div>

                    <!-- Unified Device Controls (abstracted from device type) -->
                    <div id="unified-device-controls" class="device-panel-grid device-disconnected"
                        style="border-top: 1px solid var(--border-color); margin-top: 0.75rem; padding-top: 0.75rem;">
                        <!-- Left: Controls -->
                        <div class="device-controls">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
                                <span class="status-dot"
                                    style="display: inline-block; width: 10px; height: 10px; border-radius: 50%; background: #10b981;"></span>
                                <span style="color: var(--text-secondary); font-weight: 500;">Connected</span>
                                <span id="acquisition-server-status"
                                    style="display: none; margin-left: 0.5rem; padding: 2px 8px; background: var(--accent-color); color: white; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">
                                    SERVER-MANAGED
                                </span>
                            </div>

                            <div class="device-controls-row">
                                <!-- Duration Input Group -->
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <label for="count-time"
                                        style="color: var(--text-secondary); font-size: 0.875rem;">Duration:</label>
                                    <input type="number" id="count-time" value="5" min="0.1" max="1440" step="0.5"
                                        style="width: 60px;">
                                    <span style="color: var(--text-secondary); font-size: 0.875rem;">min</span>
                                </div>

                                <!-- Acquire/Stop Actions -->
                                <button id="btn-start-acquire" class="btn-primary" style="padding: 0.4rem 0.8rem;">
                                    <img src="/static/icons/play.svg" class="icon"> Acquire
                                </button>
                                <button id="btn-stop-acquire" class="btn-stop"
                                    style="display: none; padding: 0.4rem 0.8rem; background: #f59e0b; color: white;">
                                    <img src="/static/icons/stop.svg" class="icon"> Stop
                                </button>

                                <!-- Get Current Spectrum -->
                                <button id="btn-get-current" class="btn-secondary" style="padding: 0.4rem 0.8rem;"
                                    title="Download cumulative spectrum">
                                    <img src="/static/icons/export.svg" class="icon"
                                        style="filter: invert(14%) sepia(87%) saturate(1963%) hue-rotate(188deg) brightness(97%) contrast(101%);">
                                    Get Current
                                </button>

                                <!-- Get Accumulated Spectrum (Phase 1) -->
                                <button id="btn-get-accumulated" class="btn-secondary"
                                    data-device-feature="accumulatedSpectrum"
                                    style="padding: 0.4rem 0.8rem; display: none;"
                                    title="Download accumulated spectrum (long-term)">
                                    <img src="/static/icons/history.svg" class="icon"
                                        style="filter: invert(14%) sepia(87%) saturate(1963%) hue-rotate(188deg) brightness(97%) contrast(101%);">
                                    Get Accumulated
                                </button>

                                <!-- Clear Spectrum -->
                                <button id="btn-clear-spectrum" class="btn-secondary"
                                    data-device-feature="clearSpectrum"
                                    style="padding: 0.4rem 0.8rem; border-color: #f59e0b; color: #f59e0b;"
                                    title="Clear device spectrum">
                                    <img src="/static/icons/refresh.svg" class="icon"
                                        style="filter: invert(67%) sepia(95%) saturate(356%) hue-rotate(344deg) brightness(101%) contrast(92%);">
                                    Clear
                                </button>

                                <!-- Reset Dose (Radiacode only) -->
                                <button id="btn-reset-dose" class="btn-secondary" data-device-feature="doseReset"
                                    style="padding: 0.4rem 0.8rem; border-color: #f59e0b; color: #f59e0b;"
                                    title="Reset accumulated dose">
                                    Reset Dose
                                </button>

                                <!-- Display Mode (AlphaHound only) -->
                                <div data-device-feature="displayModeToggle"
                                    style="display: flex; gap: 1px; background: var(--border-color); border-radius: 6px; padding: 1px;">
                                    <button id="btn-display-prev" class="btn-secondary"
                                        style="padding: 0.25rem 0.4rem; border: none; border-radius: 4px 0 0 4px;"
                                        title="Prev display mode">
                                        <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                            <path d="M15 18l-6-6 6-6" />
                                        </svg>
                                    </button>
                                    <button id="btn-display-next" class="btn-secondary"
                                        style="padding: 0.25rem 0.4rem; border: none; border-radius: 0 4px 4px 0;"
                                        title="Next display mode">
                                        <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                            <path d="M9 6l6 6-6 6" />
                                        </svg>
                                    </button>
                                </div>

                                <!-- Timer -->
                                <div id="acquisition-status"
                                    style="display: none; padding: 0.4rem 0.8rem; background: var(--bg-secondary); border: 1px solid var(--accent-color); border-radius: 6px; font-size: 0.85rem;">
                                    <span id="acquisition-timer"
                                        style="color: var(--accent-color); font-weight: 700;">0s</span>
                                </div>
                            </div>
                        </div>

                        <!-- Right: Live Sparkline -->
                        <div class="device-live-data" style="flex-shrink: 0; max-height: 120px;">
                            <div style="display: flex; justify-content: space-between; align-items: baseline;">
                                <span
                                    style="color: var(--text-secondary); font-size: 0.7rem; font-weight: 700; text-transform: uppercase;">Real-time
                                    Dose</span>
                                <div style="display: flex; gap: 0.75rem; align-items: center;">
                                    <div style="display: flex; flex-direction: column; align-items: flex-end;">
                                        <span id="rc-dose-display"
                                            style="font-size: 1.25rem; font-weight: 800; color: var(--accent-color);">--</span>
                                    </div>
                                    <span id="temp-display" data-device-feature="temperature"
                                        style="font-size: 0.8rem; color: var(--text-secondary); display: none;">--¬∞C</span>
                                </div>
                            </div>
                            <div class="sparkline-container" style="flex: 1; min-height: 30px; max-height: 40px;">
                                <canvas id="rcDoseRateChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Radiacode Device Panel (HIDDEN - Using unified controls from AlphaHound panel above) -->
                <div id="radiacode-quick-panel" style="display: none;">
                    <div class="device-header">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <img src="/static/icons/device.svg" class="icon icon-xl" alt="Device">
                            <h3 style="margin: 0; color: var(--secondary-color);">Radiacode Device</h3>
                        </div>

                        <div class="device-action-group"
                            style="flex: 1; display: flex; gap: 0.75rem; align-items: center; justify-content: flex-end; flex-wrap: wrap;">

                            <!-- Connection Mode -->
                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                <label style="display: flex; align-items: center; gap: 0.25rem; cursor: pointer;">
                                    <input type="radio" name="rc-conn-mode" value="usb" checked>
                                    <span style="font-size: 0.85rem;">USB</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.25rem; cursor: pointer;">
                                    <input type="radio" name="rc-conn-mode" value="bluetooth">
                                    <span style="font-size: 0.85rem;">Bluetooth</span>
                                </label>
                            </div>

                            <!-- BLE Scan and Device Selection (shown when Bluetooth selected) -->
                            <div id="rc-ble-controls" style="display: none; gap: 0.5rem; align-items: center;">
                                <button id="btn-scan-ble" class="btn-secondary"
                                    style="padding: 0.4rem 0.8rem; font-size: 0.8rem;"
                                    title="Scan for nearby Radiacode devices">
                                    <img src="/static/icons/refresh.svg" class="icon"
                                        style="width: 14px; height: 14px;">
                                    Scan
                                </button>
                                <select id="rc-ble-devices" style="min-width: 180px; font-size: 0.85rem;">
                                    <option value="">Select BLE Device...</option>
                                </select>
                                <!-- Manual MAC input fallback -->
                                <input type="text" id="rc-bluetooth-mac" placeholder="or enter MAC"
                                    style="width: 140px; font-family: monospace; font-size: 0.8rem;"
                                    title="Manual MAC address entry">
                            </div>

                            <button id="btn-connect-radiacode" class="btn-primary"
                                style="padding: 0.5rem 1.5rem; flex-shrink: 0;">Connect</button>
                        </div>
                    </div>

                    <!-- Radiacode Connected State -->
                    <div id="radiacode-connected"
                        style="display: none; border-top: 1px solid var(--border-color); margin-top: 0.75rem; padding-top: 0.75rem;">

                        <!-- Top row: Status + Buttons + Disconnect -->
                        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.5rem;">
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span class="status-dot"
                                    style="display: inline-block; width: 10px; height: 10px; border-radius: 50%; background: var(--secondary-color);"></span>
                                <span
                                    style="color: var(--text-secondary); font-weight: 500; font-size: 0.85rem;">Connected</span>
                                <span id="rc-device-model"
                                    style="font-size: 0.75rem; color: var(--text-secondary); background: var(--bg-secondary); padding: 2px 6px; border-radius: 4px;"></span>
                            </div>

                            <!-- Action buttons - compact -->
                            <div style="display: flex; gap: 0.5rem;">
                                <button id="btn-rc-get-spectrum" class="btn-primary"
                                    style="padding: 0.3rem 0.6rem; font-size: 0.8rem;">
                                    <img src="/static/icons/chart.svg" class="icon" style="width: 14px; height: 14px;">
                                    Spectrum
                                </button>
                                <button id="btn-rc-clear" class="btn-secondary"
                                    style="padding: 0.3rem 0.6rem; font-size: 0.8rem;">
                                    <img src="/static/icons/refresh.svg" class="icon"
                                        style="width: 14px; height: 14px;">
                                    Clear
                                </button>
                                <button id="btn-rc-reset-dose" class="btn-secondary" data-device-feature="doseReset"
                                    style="padding: 0.3rem 0.6rem; font-size: 0.8rem; border-color: #f59e0b; color: #f59e0b;"
                                    title="Reset accumulated dose">
                                    Reset Dose
                                </button>
                            </div>

                            <button id="btn-disconnect-radiacode"
                                style="padding: 0.3rem 0.6rem; font-size: 0.8rem; background: #ef4444; color: white; margin-left: auto;">
                                Disconnect
                            </button>
                        </div>

                        <!-- Dose rate chart - full width -->
                        <div
                            style="display: flex; align-items: center; gap: 1rem; background: var(--bg-secondary); border-radius: 8px; padding: 0.5rem 0.75rem;">
                            <div style="flex-shrink: 0; min-width: 100px;">
                                <span
                                    style="color: var(--text-secondary); font-size: 0.65rem; font-weight: 700; text-transform: uppercase; display: block;">Dose
                                    Rate</span>
                                <span id="rc-dose-display"
                                    style="font-size: 1.1rem; font-weight: 800; color: var(--secondary-color);">--</span>
                            </div>
                            <div style="flex: 1; min-height: 45px; max-height: 55px;">
                                <canvas id="rcDoseRateChart"></canvas>
                            </div>
                        </div>

                        <!-- Device Settings -->
                        <div id="radiacode-settings-panel" data-device-feature="deviceSettings"
                            style="display: none; margin-top: 1rem;">
                            <details
                                style="background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; padding: 0.75rem;">
                                <summary
                                    style="cursor: pointer; font-weight: 700; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem; user-select: none;">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2">
                                        <path
                                            d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                                    </svg>
                                    Radiacode Settings
                                </summary>

                                <div style="margin-top: 1rem; display: flex; flex-direction: column; gap: 1rem;">
                                    <!-- Brightness Slider -->
                                    <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                        <div
                                            style="display: flex; justify-content: space-between; align-items: center;">
                                            <label for="rc-brightness"
                                                style="font-size: 0.85rem; color: var(--text-secondary);">Brightness</label>
                                            <span id="rc-brightness-value"
                                                style="font-size: 0.85rem; font-weight: 700; color: var(--accent-color);">5</span>
                                        </div>
                                        <input type="range" id="rc-brightness" min="0" max="9" value="5"
                                            style="width: 100%; accent-color: var(--accent-color);">
                                    </div>

                                    <!-- Sound & Vibration Toggles -->
                                    <div style="display: flex; gap: 1rem;">
                                        <label
                                            style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; flex: 1;">
                                            <input type="checkbox" id="rc-sound"
                                                style="accent-color: var(--accent-color);">
                                            <span style="font-size: 0.85rem; color: var(--text-secondary);">Sound</span>
                                        </label>
                                        <label
                                            style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; flex: 1;">
                                            <input type="checkbox" id="rc-vibration"
                                                style="accent-color: var(--accent-color);">
                                            <span
                                                style="font-size: 0.85rem; color: var(--text-secondary);">Vibration</span>
                                        </label>
                                    </div>

                                    <!-- Display Timeout -->
                                    <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                        <label for="rc-display-timeout"
                                            style="font-size: 0.85rem; color: var(--text-secondary);">Display Timeout
                                            (seconds)</label>
                                        <input type="number" id="rc-display-timeout" min="0" value="30"
                                            style="padding: 0.4rem; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 4px; color: var(--text-primary);">
                                    </div>

                                    <!-- Language -->
                                    <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                        <label for="rc-language"
                                            style="font-size: 0.85rem; color: var(--text-secondary);">Language</label>
                                        <select id="rc-language"
                                            style="padding: 0.4rem; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 4px; color: var(--text-primary);">
                                            <option value="en">English</option>
                                            <option value="ru">–†—É—Å—Å–∫–∏–π</option>
                                        </select>
                                    </div>

                                    <!-- View Configuration Button -->
                                    <button id="btn-view-config" data-device-feature="deviceConfig"
                                        class="btn-secondary"
                                        style="padding: 0.4rem 0.8rem; font-size: 0.85rem; display: none;">
                                        View Configuration
                                    </button>
                                </div>
                            </details>
                        </div>
                    </div>
                </div>

                <!-- Drop Zone (compact) -->
                <div class="upload-container" id="drop-zone"
                    style="max-width: 200px; min-height: 100px; padding: 1rem; flex-shrink: 0;">
                    <div class="upload-icon">
                        <img src="/static/icons/upload.svg" style="width: 32px; height: 32px;">
                    </div>
                    <h2 style="font-size: 0.85rem; margin: 0.25rem 0 0 0;">Drop file</h2>
                    <p style="font-size: 0.7rem; margin: 0.15rem 0 0 0;">or click to browse</p>
                    <input type="file" id="file-input" accept=".n42,.xml,.csv">
                </div>
            </div>
            <!-- End device panels wrapper -->

        </div>
        </div>

        <div id="dashboard" style="display: none;">
            <div class="metadata-panel" id="metadata-panel">
                <!-- Populated by JS -->
            </div>

            <div class="controls">

                <!-- Export Group -->
                <div class="control-group">
                    <span class="control-label">Export</span>
                    <button id="btn-export-json">JSON</button>
                    <button id="btn-export-csv">CSV</button>
                    <button id="btn-export-pdf" class="btn-accent"><img src="/static/icons/pdf.svg" class="icon">
                        PDF</button>
                    <button id="btn-export-n42" class="btn-accent"><img src="/static/icons/upload.svg" class="icon">
                        N42</button>
                </div>

                <!-- Right Group: Tools -->
                <div class="control-group">

                    <span class="control-label">Tools</span>
                    <button id="btn-edit-n42" class="btn-accent" title="Edit N42 Metadata"><img
                            src="/static/icons/settings.svg" class="icon"> Metadata</button>
                    <button id="btn-analysis" title="Advanced Analysis"><img src="/static/icons/analysis.svg"
                            class="icon"> Analysis</button>
                </div>
            </div>

            <div id="compare-panel" style="display: none;" class="compare-panel">
                <strong>Comparison Mode:</strong>
                <span id="overlay-count">0 spectra loaded</span>
                <button id="btn-add-file">+ Add Spectrum</button>
                <button id="btn-clear-overlays">Clear All</button>
                <input type="file" id="compare-file-input" accept=".n42,.xml,.csv" style="display:none;">
            </div>

            <div id="analysis-panel" style="display: none;" class="compare-panel">
                <div
                    style="display: flex; justify-content: flex-start; align-items: center; width: 100%; gap: 1.5rem; margin-bottom: 0.5rem;">
                    <strong>Spectral Analysis</strong>
                    <div style="display: flex; gap: 8px;">
                        <button id="btn-estimator-tool" class="btn-primary"
                            style="padding: 6px 14px; font-size: 0.85rem; background: var(--bg-secondary); border: 1px solid var(--accent-color); color: var(--accent-color);">
                            <img src="/static/icons/timer.svg" class="icon"
                                style="width: 14px; height: 14px; margin-right: 0.25rem;"> Estimator</button>
                        <button id="btn-decay-tool" class="btn-primary" style="padding: 6px 14px; font-size: 0.85rem;">
                            <img src="/static/icons/chart.svg" class="icon" style="margin-right: 0.25rem;"> Decay
                            Tool</button>
                        <button id="btn-ml-identify" class="btn-primary"
                            style="padding: 6px 14px; font-size: 0.85rem;"><img src="/static/icons/robot.svg"
                                class="icon" style="margin-right: 0.25rem;">AI Identify</button>
                        <button id="btn-run-fit" class="btn-primary" style="padding: 6px 14px; font-size: 0.85rem;">Run
                            Peak Fitting</button>
                    </div>
                </div>
                <div id="analysis-results" style="margin-top: 10px; width: 100%; overflow-x: auto;">
                    <p style="color: #94a3b8; font-size: 0.9rem;">Click "Run Peak Fitting" to calculate FWHM and Net
                        Area.</p>
                </div>

                <div style="display: flex; gap: 1rem; margin-top: 1rem; align-items: stretch;">
                    <div id="calibration-section" class="analysis-sub-section"
                        style="flex: 1; margin-top: 0; display: flex; flex-direction: column;">
                        <strong>Calibration</strong>
                        <div style="flex-grow: 1; display: flex; align-items: center;">
                            <button id="btn-calibrate-mode"
                                style="font-size: 0.85rem; padding: 6px 12px; font-weight: 600;">Open Calibration
                                Tool</button>
                        </div>
                    </div>

                    <div id="background-section" class="analysis-sub-section"
                        style="flex: 2; margin-top: 0; display: flex; flex-direction: column;">
                        <strong>Background Subtraction</strong>
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 0.5rem;">
                            <button id="btn-snip-bg" class="btn-primary" style="font-size: 0.85rem; padding: 6px 12px;"
                                title="Auto-remove Compton continuum using SNIP algorithm">Auto Remove BG</button>
                            <button id="btn-load-bg" style="font-size: 0.85rem; padding: 6px 12px;">Load Background
                                File</button>
                            <button id="btn-set-current-bg" style="font-size: 0.85rem; padding: 6px 12px;">Use Current
                                as
                                BG</button>
                            <button id="btn-clear-bg"
                                style="font-size: 0.85rem; padding: 6px 12px; background: #ef4444; color: white; border: none; display:none;">Clear
                                BG</button>
                        </div>
                        <div id="bg-status"
                            style="margin-top: auto; font-size: 0.8rem; color: var(--text-secondary); font-style: italic;">
                            No background loaded.
                        </div>
                        <input type="file" id="bg-file-input" accept=".n42,.xml,.csv" style="display:none;">
                    </div>
                </div>
            </div>

            <div class="chart-container">
                <div class="chart-header">
                    <div class="chart-title">
                        <img src="/static/icons/chart.svg" class="icon" style="width: 20px; height: 20px;">
                        <span>Gamma Spectrum Analysis</span>
                    </div>
                    <div class="chart-actions">
                        <button id="btn-compare" title="Compare Mode"
                            style="font-size: 0.8rem; padding: 4px 10px; margin-right: 0.5rem; border-color: var(--secondary-color); color: var(--secondary-color);">
                            <img src="/static/icons/compare.svg" class="icon"
                                style="width: 14px; height: 14px; margin-right: 2px;"> Compare
                        </button>
                        <button id="btn-lin" class="active"
                            style="font-size: 0.8rem; padding: 4px 10px;">Linear</button>
                        <button id="btn-log" style="font-size: 0.8rem; padding: 4px 10px;">Logarithmic</button>
                        <button id="btn-reset-zoom" style="font-size: 0.8rem; padding: 4px 10px;">Reset Zoom</button>
                        <button id="btn-auto-scale" class="active" style="font-size: 0.8rem; padding: 4px 10px;"
                            title="Toggle between Auto-Scale and Full Spectrum">Auto-Scale</button>
                    </div>
                </div>
                <div style="flex-grow: 1; position: relative; min-height: 0;">
                    <canvas id="spectrumChart"></canvas>
                </div>
            </div>

            <!-- Scrubby Zoom Slider -->
            <div id="zoom-scrubber" class="zoom-scrubber-container" style="display: none;">
                <div class="zoom-scrubber-track">
                    <canvas id="scrubber-preview" class="scrubber-preview"></canvas>
                    <div id="scrubber-selection" class="scrubber-selection"></div>
                </div>
                <div class="zoom-scrubber-controls">
                    <input type="range" id="zoom-min" class="zoom-handle zoom-handle-min" min="0" max="100" value="0"
                        step="0.1">
                    <input type="range" id="zoom-max" class="zoom-handle zoom-handle-max" min="0" max="100" value="100"
                        step="0.1">
                </div>
                <div class="zoom-scrubber-labels">
                    <span id="zoom-min-label">0 keV</span>
                    <span style="flex: 1;"></span>
                    <span id="zoom-max-label">3000 keV</span>
                </div>
            </div>

            <div id="peaks-container" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                    <h3 style="margin: 0;">Detected Peaks</h3>
                    <button id="btn-toggle-peaks" class="btn-secondary"
                        style="font-size: 0.8rem; padding: 2px 8px;">Hide</button>
                </div>
                <div id="peaks-scroll-area" class="scrollable-table-area">
                    <table id="peaks-table" class="data-table">
                        <thead>
                            <tr>
                                <th>Energy (keV)</th>
                                <th class="text-right">Counts</th>
                            </tr>
                        </thead>
                        <tbody id="peaks-tbody"></tbody>
                    </table>
                </div>
            </div>

            <div id="isotopes-container" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h3 style="margin: 0;"><img src="/static/icons/analysis.svg" class="icon"> Isotope
                        Identification
                    </h3>
                    <div style="display: flex; gap: 0.5rem;">
                        <button id="btn-run-ml" class="btn-primary"
                            style="padding: 6px 12px; font-size: 0.85rem; display: flex; align-items: center; gap: 4px;">
                            <img src="/static/icons/robot.svg" class="icon" style="margin-right: 0.25rem;">AI
                            Identify
                        </button>
                    </div>
                </div>

                <!-- Dual Detection Results -->
                <div id="identification-results" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">

                    <!-- Legacy Peak-Based Results -->
                    <div class="detection-panel"
                        style="background: var(--card-bg); border-radius: 10px; padding: 1rem; border: 1px solid var(--border-color);">
                        <div
                            style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--border-color);">
                            <img src="/static/icons/chart.svg" class="icon" style="margin-right: 0.25rem;">
                            <strong style="color: var(--text-primary);">Peak Matching</strong>
                            <span
                                style="font-size: 0.75rem; color: var(--text-secondary); margin-left: auto;">Legacy</span>
                        </div>
                        <div id="legacy-isotopes-list">
                            <!-- Populated by JS -->
                        </div>
                    </div>

                    <!-- ML-Based Results -->
                    <div class="detection-panel"
                        style="background: linear-gradient(135deg, rgba(56, 189, 248, 0.1), rgba(139, 92, 246, 0.1)); border-radius: 10px; padding: 1rem; border: 1px solid var(--accent-color);">
                        <div
                            style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--accent-color);">
                            <img src="/static/icons/robot.svg" class="icon" style="margin-right: 0.25rem;">
                            <strong style="color: var(--accent-color);">AI Identification</strong>
                            <span
                                style="font-size: 0.65rem; background: orange; color: black; padding: 2px 6px; border-radius: 4px; font-weight: bold;">WIP</span>
                            <span style="font-size: 0.75rem; color: var(--text-secondary); margin-left: auto;">PyRIID
                                ML</span>
                        </div>
                        <div id="ml-isotopes-list">
                            <p style="color: var(--text-secondary); font-size: 0.875rem; font-style: italic;">Click
                                "AI
                                Identify" to run ML classification</p>
                        </div>
                    </div>
                </div>

                <!-- Info Bar -->
                <div
                    style="margin-top: 1rem; padding: 0.75rem; background: rgba(56, 189, 248, 0.1); border-radius: 8px; font-size: 0.8rem; color: var(--text-secondary);">
                    <strong><img src="/static/icons/lightbulb.svg" class="icon"
                            style="margin-right: 0.25rem; vertical-align: middle;">Tip:</strong> Peak Matching uses
                    known gamma energies
                    from IAEA/NNDC databases. AI
                    Identification uses a neural network trained on 90+ isotopes for pattern recognition.
                </div>
            </div>

            <div id="decay-chains-container" style="display: none; margin-top: 2rem;">
                <h3><img src="/static/icons/analysis.svg" class="icon"> Decay Chains Detected</h3>
                <div id="decay-chains-list">
                    <!-- Populated by JS -->
                </div>
            </div>

            <!-- ROI Analysis Panel (Advanced Mode Only) -->
            <div id="roi-analysis-panel" style="display: none;">
                <h3><img src="/static/icons/analysis.svg" class="icon"> Region-of-Interest (ROI) Analysis</h3>

                <!-- Configuration Grid -->
                <!-- Use CSS Grid for layout -->
                <style>
                    .roi-grid {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
                        gap: 1.5rem;
                        padding: 1.5rem;
                        background: var(--bg-secondary);
                        border-radius: 8px;
                        margin-bottom: 0.75rem;
                        align-items: end;
                    }

                    .roi-field {
                        display: flex;
                        flex-direction: column;
                        gap: 0.35rem;
                        font-size: 0.85rem;
                        color: var(--text-secondary);
                    }

                    .roi-field select,
                    .roi-field input {
                        padding: 0.4rem;
                        border: 1px solid var(--border-color);
                        border-radius: 4px;
                        background: var(--bg-primary);
                        color: var(--text-primary);
                        width: 100%;
                    }

                    .roi-actions {
                        display: flex;
                        gap: 0.5rem;
                        grid-column: 1 / -1;
                        padding-top: 0.5rem;
                        border-top: 1px solid var(--border-color);
                        margin-top: 0.25rem;
                    }
                </style>

                <div class="roi-grid">
                    <label class="roi-field">
                        Source Type
                        <select id="roi-source-type">
                            <option value="unknown">Standard Analysis (Default)</option>
                            <option value="uranium_glass">Uranium Glass (Vaseline)</option>
                            <option value="uranium_ore">Uranium Ore (Natural)</option>
                            <option value="thoriated_lens">Thoriated Camera Lens</option>
                            <option value="takumar_lens">Takumar Lens (Th + Natural U)</option>
                            <option value="radium_dial">Radium Dial (Watch/Clock)</option>
                            <option value="smoke_detector">Smoke Detector (Am-241)</option>
                            <option value="cesium_source">Cesium-137 Source</option>
                            <option value="cobalt_source">Cobalt-60 Source</option>
                            <option value="natural_background">Natural Background</option>
                        </select>
                    </label>

                    <label class="roi-field">
                        Detector
                        <select id="roi-detector">
                            <option value="AlphaHound CsI(Tl)">CsI(Tl) 1.1cm¬≥</option>
                            <option value="AlphaHound BGO">BGO 0.6cm¬≥</option>
                        </select>
                    </label>

                    <label class="roi-field">
                        Acq. Time (min)
                        <input type="number" id="roi-acq-time" value="10" min="0.1" max="600000" step="0.1">
                    </label>

                    <label class="roi-field">
                        Target Isotope
                        <select id="roi-isotope">
                            <option value="U-235 (186 keV)">U-235 (186 keV)</option>
                            <option value="Th-234 (93 keV)">Th-234 (93 keV)</option>
                            <option value="Bi-214 (609 keV)">Bi-214 (609 keV)</option>
                            <option value="Cs-137 (662 keV)">Cs-137 (662 keV)</option>
                            <option value="Co-60 (1173 keV)">Co-60 (1173 keV)</option>
                            <option value="Co-60 (1332 keV)">Co-60 (1332 keV)</option>
                            <option value="K-40 (1461 keV)">K-40 (1461 keV)</option>
                            <option value="Am-241 (60 keV)">Am-241 (60 keV)</option>
                            <option value="Tl-208 (2614 keV)">Tl-208 (2614 keV)</option>
                            <option value="Ac-228 (911 keV)">Ac-228 (911 keV)</option>
                            <option value="Pb-214 (352 keV)">Pb-214 (352 keV)</option>
                            <option value="Pa-234m (1001 keV)">Pa-234m (1001 keV)</option>
                        </select>
                    </label>

                    <div class="roi-actions">
                        <button id="btn-analyze-roi" class="btn-primary"
                            style="padding: 0.5rem 1.5rem; flex: 1;">Analyze ROI</button>
                        <button id="btn-highlight-roi" class="btn-secondary"
                            style="padding: 0.5rem 1rem;">Highlight</button>
                        <button id="btn-clear-highlight" class="btn-secondary"
                            style="padding: 0.5rem 1rem;">Clear</button>
                    </div>
                </div>

                <!-- Compact Source Info Banner -->
                <div id="roi-source-info"
                    style="display: none; padding: 0.5rem 0.75rem; background: rgba(56, 189, 248, 0.1); border-left: 3px solid var(--accent-color); border-radius: 4px; margin-bottom: 0.75rem; font-size: 0.8rem; color: var(--text-primary);">
                    <span id="roi-source-info-text"></span>
                </div>

                <!-- Results Section -->
                <div id="roi-results"
                    style="padding: 1rem; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; font-family: 'Roboto Mono', monospace; font-size: 0.85rem; line-height: 1.6; min-height: 80px;">
                    <p style="color: var(--text-secondary); font-style: italic; margin: 0;">
                        Select an isotope and click "Analyze ROI".
                    </p>
                </div>
            </div>
        </div>

        <!-- File History Modal -->
        <div id="history-modal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>File History</h3>
                    <button id="close-history" class="close-btn"><img src="/static/icons/close.svg" class="icon"
                            style="width: 16px; height: 16px;"></button>
                </div>
                <div id="history-list"></div>
            </div>
        </div>

        <!-- Settings Modal -->
        <div id="settings-modal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3><img src="/static/icons/settings.svg" class="icon"> Analysis Settings</h3>
                    <button id="close-settings" class="close-btn"><img src="/static/icons/close.svg" class="icon"
                            style="width: 16px; height: 16px;"></button>
                </div>

                <div style="margin: 1.5rem 0;">
                    <h4 style="margin-bottom: 1rem;">UI Complexity Mode</h4>
                    <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
                        <label
                            style="cursor: pointer; padding: 0.5rem 1rem; border: 2px solid var(--border-color); border-radius: 6px; transition: all 0.3s;">
                            <input type="radio" name="ui-mode" value="simple" checked style="margin-right: 0.5rem;">
                            <strong>Simple</strong>
                        </label>
                        <label
                            style="cursor: pointer; padding: 0.5rem 1rem; border: 2px solid var(--border-color); border-radius: 6px; transition: all 0.3s;">
                            <input type="radio" name="ui-mode" value="advanced" style="margin-right: 0.5rem;">
                            <strong>Advanced</strong>
                        </label>
                        <label
                            style="cursor: pointer; padding: 0.5rem 1rem; border: 2px solid var(--border-color); border-radius: 6px; transition: all 0.3s;">
                            <input type="radio" name="ui-mode" value="expert" style="margin-right: 0.5rem;">
                            <strong>Expert</strong>
                        </label>
                    </div>
                    <p style="margin-top: 0.5rem; color: var(--text-secondary); font-size: 0.8rem;">
                        <strong>Simple:</strong> Chart + Peaks + Isotopes only |
                        <strong>Advanced:</strong> + ROI, BG, Calibration |
                        <strong>Expert:</strong> + All analysis tools
                    </p>
                </div>

                <div style="margin: 1.5rem 0;">
                    <h4 style="margin-bottom: 1rem;">Threshold Presets</h4>
                    <div style="display: flex; gap: 1rem;">
                        <label
                            style="cursor: pointer; padding: 0.5rem 1rem; border: 2px solid var(--border-color); border-radius: 6px; transition: all 0.3s;">
                            <input type="radio" name="analysis-mode" value="simple" checked
                                style="margin-right: 0.5rem;">
                            <strong>Optimized</strong> (Recommended)
                        </label>
                        <label
                            style="cursor: pointer; padding: 0.5rem 1rem; border: 2px solid var(--border-color); border-radius: 6px; transition: all 0.3s;">
                            <input type="radio" name="analysis-mode" value="advanced" style="margin-right: 0.5rem;">
                            <strong>Custom</strong> (Edit below)
                        </label>
                    </div>
                    <p style="margin-top: 0.5rem; color: var(--text-secondary); font-size: 0.875rem;">Optimized uses
                        tuned defaults for hobby-level sources. Custom unlocks threshold sliders.</p>
                </div>

                <div id="advanced-settings"
                    style="display: none; margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color);">
                    <h4 style="margin-bottom: 1rem;">Detection Thresholds</h4>

                    <div style="margin-bottom: 1.5rem;">
                        <label
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <span>Isotope Min Confidence:</span>
                            <strong><span id="iso-conf-val">40</span>%</strong>
                        </label>
                        <input type="range" id="isotope-confidence" min="10" max="90" value="40" step="5"
                            style="width: 100%;">
                        <p style="color: var(--text-secondary); font-size: 0.75rem; margin-top: 0.25rem;">Minimum %
                            of
                            characteristic peaks required to report an isotope</p>
                    </div>

                    <div style="margin-bottom: 1.5rem;">
                        <label
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <span>Chain Min Confidence:</span>
                            <strong><span id="chain-conf-val">30</span>%</strong>
                        </label>
                        <input type="range" id="chain-confidence" min="10" max="90" value="30" step="5"
                            style="width: 100%;">
                        <p style="color: var(--text-secondary); font-size: 0.75rem; margin-top: 0.25rem;">Minimum
                            confidence to report a decay chain</p>
                    </div>

                    <div style="margin-bottom: 1.5rem;">
                        <label
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <span>Energy Tolerance:</span>
                            <strong><span id="energy-tol-val">20</span> keV</strong>
                        </label>
                        <input type="range" id="energy-tolerance" min="5" max="50" value="20" step="1"
                            style="width: 100%;">
                        <p style="color: var(--text-secondary); font-size: 0.75rem; margin-top: 0.25rem;">Maximum
                            energy
                            difference for peak matching</p>
                    </div>

                    <button id="btn-reset-defaults"
                        style="padding: 0.5rem 1rem; border-radius: 6px; margin-right: 0.5rem;">Reset to
                        Defaults</button>
                </div>

                <div
                    style="text-align: right; margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color); display:flex; justify-content:space-between; align-items:center;">
                    <button id="btn-manage-isotopes"
                        style="background:transparent; border:1px solid var(--border-color); color:var(--text-primary);">Manage
                        Custom Isotopes</button>
                    <button id="btn-apply-settings" class="btn-primary">Apply Settings</button>
                </div>
            </div>
        </div>


        <!-- Calibration Modal -->
        <div id="calibration-modal" class="modal" style="display: none;">
            <div class="modal-content" style="padding: 1.5rem;">
                <div class="modal-header">
                    <h3>Energy Calibration</h3>
                    <button id="close-calibration" class="close-btn"><img src="/static/icons/close.svg" class="icon"
                            style="width: 16px; height: 16px;"></button>
                </div>
                <div style="margin: 1rem 0;">
                    <p>Click on the chart to add points (Channel), then enter the known energy.</p>
                    <table style="width: 100%; text-align: left; margin-bottom: 1rem;">
                        <thead>
                            <tr>
                                <th>Channel</th>
                                <th>Energy (keV)</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="cal-points-tbody"></tbody>
                    </table>
                    <div id="cal-results"
                        style="display:none; background: #f0fdf4; padding: 0.5rem; border-radius: 6px; margin-bottom: 1rem; border: 1px solid #86efac;">
                        <strong>Fit Results:</strong><br>
                        Slope: <span id="cal-slope"></span><br>
                        Intercept: <span id="cal-intercept"></span>
                    </div>
                    <div style="text-align: right;">
                        <button id="btn-cal-calculate">Calculate Fit</button>
                        <button id="btn-cal-apply" class="btn-primary" style="display:none;">Apply to View</button>
                    </div>
                </div>
            </div>
        </div>
        <!-- Custom Isotopes Modal -->
        <div id="isotopes-modal" class="modal" style="display: none; z-index: 1100;">
            <div class="modal-content" style="max-width: 650px;">
                <div class="modal-header">
                    <h3>Custom Isotopes</h3>
                    <button id="close-isotopes" class="close-btn"><img src="/static/icons/close.svg" class="icon"
                            style="width: 16px; height: 16px;"></button>
                </div>

                <!-- Add Isotope Form -->
                <div style="margin-bottom: 1.5rem;">
                    <form id="add-isotope-form"
                        style="display: grid; grid-template-columns: 1fr 2fr auto; gap: 12px; align-items: end;">
                        <div>
                            <label
                                style="display: block; font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 6px;">Name</label>
                            <input type="text" id="iso-name" placeholder="MySource" required
                                style="width: 100%; padding: 10px; height: 42px; box-sizing: border-box;">
                        </div>
                        <div>
                            <label
                                style="display: block; font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 6px;">Energies
                                (keV)</label>
                            <input type="text" id="iso-energies" placeholder="e.g. 662, 32" required
                                style="width: 100%; padding: 10px; height: 42px; box-sizing: border-box;">
                        </div>
                        <button type="submit" class="btn-primary"
                            style="padding: 10px 20px; height: 42px; white-space: nowrap;">Add</button>
                    </form>
                </div>

                <!-- Isotopes List -->
                <div style="margin-bottom: 1.5rem;">
                    <h4
                        style="border-bottom: 1px solid var(--border-color); padding-bottom: 8px; margin-bottom: 12px; font-size: 1rem;">
                        Your Isotopes
                    </h4>
                    <div id="custom-isotopes-list"
                        style="min-height: 60px; max-height: 200px; overflow-y: auto; padding: 8px; background: var(--bg-primary); border-radius: 6px;">
                    </div>
                </div>

                <!-- Import/Export Buttons -->
                <div style="display: flex; gap: 10px; padding-top: 1rem; border-top: 1px solid var(--border-color);">
                    <button id="btn-import-isotopes" class="btn-secondary"
                        style="flex: 1; padding: 10px 16px; display: flex; align-items: center; justify-content: center; gap: 8px;">
                        <img src="/static/icons/import.svg" style="width: 18px; height: 18px;" alt="">
                        Import JSON
                    </button>
                    <button id="btn-export-isotopes" class="btn-secondary"
                        style="flex: 1; padding: 10px 16px; display: flex; align-items: center; justify-content: center; gap: 8px;">
                        <img src="/static/icons/export.svg" style="width: 18px; height: 18px;" alt="">
                        Export JSON
                    </button>
                </div>
            </div>
        </div>

        <!-- Decay Prediction Modal -->
        <!-- Acquisition Estimator Modal -->
        <div id="estimator-modal" class="modal" style="display: none; z-index: 1200;">
            <div class="modal-content" style="max-width: 700px; padding: 1.5rem;">
                <div class="modal-header" style="margin-bottom: 2rem;">
                    <h3 style="margin: 0; color: var(--primary-color);">Acquisition Estimator & Projection</h3>
                    <button id="close-estimator" class="close-btn" style="line-height: 1;"><img
                            src="/static/icons/close.svg" class="icon" style="width: 16px; height: 16px;"></button>
                </div>

                <div class="tabs"
                    style="display: flex; gap: 1rem; border-bottom: 1px solid var(--border-color); margin-bottom: 1rem;">
                    <button id="tab-projection" class="tab-btn active"
                        style="padding: 8px 16px; border-bottom: 2px solid var(--accent-color);">Probe
                        Projection</button>
                    <button id="tab-time-est" class="tab-btn" style="padding: 8px 16px; opacity: 0.7;">Time
                        Calculator</button>
                    <button id="tab-mda" class="tab-btn" style="padding: 8px 16px; opacity: 0.7;">MDA
                        Calculator</button>
                </div>

                <!-- Tab 1: Projection -->
                <div id="panel-projection">
                    <p style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 1rem;">
                        Estimate spectrum appearance for longer acquisition times based on current statistics.
                    </p>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div>
                            <label style="display: block; font-size: 0.8rem; color: var(--text-secondary);">Current Live
                                Time (s)</label>
                            <input type="number" id="est-current-time" readonly
                                style="width: 100%; padding: 8px; background: #334ab92b; border: 1px solid var(--border-color); color: var(--text-color);">
                        </div>
                        <div>
                            <label style="display: block; font-size: 0.8rem; color: var(--text-secondary);">Target
                                Duration (Minutes)</label>
                            <input type="number" id="est-target-time" value="60" min="1" step="1"
                                style="width: 100%; padding: 8px; border: 1px solid var(--border-color); background: var(--bg-secondary); color: var(--text-color);">
                        </div>
                    </div>

                    <div
                        style="background: var(--bg-secondary); padding: 1rem; border-radius: 6px; margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span>Scaling Factor:</span>
                            <span id="est-factor" style="font-weight: bold; color: var(--accent-color);">1.0x</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span>Projected Total Counts:</span>
                            <span id="est-proj-counts">--</span>
                        </div>
                    </div>

                    <div style="display: flex; gap: 10px;">
                        <button id="btn-calc-projection" class="btn-primary" style="flex: 1;">Update Stats</button>
                        <button id="btn-show-projection" class="btn-accent" style="flex: 1;">Show Overlay</button>
                    </div>
                </div>

                <!-- Tab 2: Time Estimator -->
                <div id="panel-time-est" style="display: none;">
                    <p style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 1rem;">
                        Determine acquisition time for an unknown spectrum by comparing Total Counts to a measured Count
                        Rate.
                    </p>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div>
                            <label style="display: block; font-size: 0.8rem; color: var(--text-secondary);">Spectrum
                                Total Counts</label>
                            <input type="number" id="est-total-counts" placeholder="Auto-filled from file"
                                style="width: 100%; padding: 8px; font-weight: bold; background: #334ab92b; border: 1px solid var(--border-color); color: var(--text-color);">
                        </div>
                        <div>
                            <label style="display: block; font-size: 0.8rem; color: var(--text-secondary);">Count Rate
                                (CPM)</label>
                            <input type="number" id="est-cpm" placeholder="Enter Rate..."
                                style="width: 100%; padding: 8px; font-size: 1.1rem; background: var(--bg-secondary); color: var(--text-color); border: 1px solid var(--border-color);">
                        </div>
                    </div>

                    <div style="margin-bottom: 1rem;">
                        <button id="btn-calc-time" class="btn-primary" style="width: 100%;">Calculate Duration</button>
                    </div>

                    <div id="time-est-result"
                        style="text-align: center; padding: 1rem; border: 1px dashed var(--border-color); border-radius: 6px; display:none;">
                        <div style="font-size: 0.8rem; color: var(--text-secondary);">Estimated Acquisition Time</div>
                        <div id="est-duration-result"
                            style="font-size: 1.5rem; font-weight: bold; color: var(--accent-color);">--</div>
                    </div>
                </div>

                <!-- Tab 3: MDA -->
                <div id="panel-mda" style="display: none;">
                    <p style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 1rem;">
                        Calculate Minimum Detectable Activity (Cursie Limit) for specific parameters.
                    </p>
                    <div style="display: grid; grid-template-columns: 1fr; gap: 10px; margin-bottom: 1rem;">
                        <div>
                            <label style="display: block; font-size: 0.8rem; color: var(--text-secondary);">Detector
                                Profile</label>
                            <select id="est-detector"
                                style="width: 100%; padding: 8px; background: var(--bg-secondary); color: var(--text-color); border: 1px solid var(--border-color);">
                                <option value="AlphaHound CsI(Tl)">AlphaHound CsI(Tl)</option>
                                <!-- Populated by JS -->
                            </select>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <div>
                                <label>Background Counts</label>
                                <input type="number" id="est-bg-counts" value="50"
                                    style="width: 100%; padding: 8px; background: var(--bg-secondary); color: var(--text-color); border: 1px solid var(--border-color);">
                            </div>
                            <div>
                                <label>Time (Seconds)</label>
                                <input type="number" id="est-mda-time" value="60"
                                    style="width: 100%; padding: 8px; background: var(--bg-secondary); color: var(--text-color); border: 1px solid var(--border-color);">
                            </div>
                        </div>
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <button id="btn-calc-mda" class="btn-primary" style="width: 100%;">Calculate MDA</button>
                    </div>
                    <div id="mda-result"
                        style="padding: 1rem; border: 1px dashed var(--border-color); text-align: center; display: none;">
                        <div style="font-size: 0.8rem; color: var(--text-secondary);">Minimum Detectable Activity</div>
                        <div id="mda-value" style="font-size: 1.5rem; font-weight: bold; color: var(--accent-color);">--
                            Bq</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Decay Prediction Modal (Restored) -->
        <div id="decay-modal" class="modal" style="display: none; z-index: 1200;">
            <div class="modal-content" style="max-width: 900px; padding: 1.5rem;">
                <div class="modal-header" style="margin-bottom: 2rem;">
                    <h3 style="margin: 0; color: var(--primary-color);">Radioactive Decay Prediction</h3>
                    <button id="close-decay" class="close-btn" style="line-height: 1;"><img
                            src="/static/icons/close.svg" class="icon" style="width: 16px; height: 16px;"></button>
                </div>
                <div
                    style="display: grid; grid-template-columns: 1.2fr 1fr 1fr auto; gap: 1.5rem; margin-bottom: 2rem; align-items: end; background: rgba(255,255,255,0.02); padding: 1.5rem; border-radius: 12px; border: 1px solid var(--border-color);">
                    <div>
                        <label
                            style="display: block; font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.5rem;">Parent
                            Isotope</label>
                        <select id="decay-isotope"
                            style="width: 100%; padding: 0.6rem; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-color);">
                            <option value="Cs-137">Cs-137</option>
                            <option value="Co-60">Co-60</option>
                            <option value="Sr-90">Sr-90</option>
                            <option value="U-238" selected>U-238</option>
                            <option value="Th-232">Th-232</option>
                            <option value="Am-241">Am-241</option>
                            <option value="Ra-226">Ra-226</option>
                        </select>
                    </div>
                    <div>
                        <label
                            style="display: block; font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.5rem;">Initial
                            Activity (Bq)</label>
                        <input type="number" id="decay-activity" value="10000"
                            style="width: 100%; padding: 0.6rem; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-color);">
                    </div>
                    <div>
                        <label
                            style="display: block; font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.5rem;">Duration
                            (Years)</label>
                        <input type="number" id="decay-duration" value="100"
                            style="width: 100%; padding: 0.6rem; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-color);">
                    </div>
                    <button id="btn-run-decay" class="btn-primary"
                        style="height: 42px; padding: 0 1.5rem;">Calculate</button>
                </div>
                <div style="height: 400px; position: relative;">
                    <canvas id="decayChart"></canvas>
                </div>
            </div>
        </div>

    </main>

    <!-- Main Application Logic (ES6 Modules) -->
    <script type="module" src="/static/js/main.js?v=4.9"></script>
</body>

</html>