<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RadTrace - Gamma Spectroscopy Analysis</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/style.css?v=2">
    <link rel="stylesheet" href="/static/button-fixes.css?v=2">
    <link rel="icon" type="image/svg+xml" href="/static/icons/favicon.svg">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
    <script
        src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
</head>

<body>
    <header>
        <h1><img src="/static/icons/rocket.svg" class="icon icon-xl" style="margin-right:0.5rem;">RadTrace</h1>
        <div class="header-controls">
            <button id="btn-history" title="File History"><img src="/static/icons/history.svg" class="icon">
                History</button>
            <button id="btn-settings" title="Analysis Settings"><img src="/static/icons/settings.svg" class="icon">
                Settings</button>
            <button id="btn-theme" title="Toggle Light/Dark Mode"><img src="/static/icons/theme.svg"
                    class="icon"></button>
        </div>
    </header>



    <main>
        <!-- AlphaHound Device Quick Connect -->
        <div id="device-quick-panel"
            style="background: var(--card-bg); border: 2px solid var(--accent-color); border-radius: 12px; padding: 1rem; margin-bottom: 1.5rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
            <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;">
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <img src="/static/icons/device.svg" class="icon icon-xl" alt="Device">
                    <h3 style="margin: 0; color: var(--accent-color);">AlphaHound Device</h3>
                </div>

                <div style="flex: 1; display: flex; gap: 0.5rem; align-items: center; min-width: 300px;">
                    <select id="port-select"
                        style="flex: 1; padding: 0.5rem; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-color);">
                        <option value="">Select Serial Port...</option>
                    </select>
                    <button id="btn-refresh-ports"
                        style="padding: 0.5rem 1rem; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer;"><img
                            src="/static/icons/refresh.svg" class="icon" style="margin:0;"></button>
                </div>

                <div style="display: flex; gap: 0.5rem;">
                    <button id="btn-connect-device" class="btn-primary"
                        style="padding: 0.5rem 1.5rem; background: var(--accent-color); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">Connect</button>
                </div>
            </div>

            <div id="device-connected"
                style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid var(--border-color); display: none;">
                <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <span style="color: #10b981; font-size: 1.2rem;">●</span>
                        <span style="color: var(--text-secondary);">Connected</span>
                    </div>
                    <div style="background: var(--card-bg); padding: 0.5rem 1rem; border-radius: 6px;">
                        <span style="color: var(--text-secondary); font-size: 0.875rem;">Dose Rate:</span>
                        <span id="dose-display"
                            style="color: var(--accent-color); font-weight: 600; margin-left: 0.5rem;">-- µRem/hr</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <label for="count-time" style="color: var(--text-secondary); font-size: 0.875rem;">Count
                            Duration:</label>
                        <input type="number" id="count-time" value="5" min="0.1" max="1440" step="0.5"
                            style="width: 60px; padding: 0.25rem 0.5rem; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 4px; color: var(--text-color);">
                        <span style="color: var(--text-secondary); font-size: 0.875rem;">min</span>
                    </div>
                    <button id="btn-start-acquire" class="btn-primary"
                        style="padding: 0.5rem 1rem; background: var(--accent-color); color: white; border: none; border-radius: 6px; cursor: pointer;"><img
                            src="/static/icons/play.svg" class="icon">
                        Acquire Spectrum</button>
                    <button id="btn-stop-acquire" class="btn-stop"
                        style="padding: 0.5rem 1rem; background: #f59e0b; color: white; border: none; border-radius: 6px; cursor: pointer; display: none;"><img
                            src="/static/icons/stop.svg" class="icon">
                        Stop Acquisition</button>
                    <div id="acquisition-status"
                        style="display: none; padding: 0.5rem 1rem; background: var(--card-bg); border-radius: 6px; border: 1px solid var(--border-color);">
                        <span style="color: var(--accent-color); font-weight: 600;">Acquiring: <span
                                id="acquisition-timer">0s</span></span>
                    </div>
                    <button id="btn-disconnect-device"
                        style="padding: 0.5rem 1rem; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer;">Disconnect</button>
                </div>
            </div>
        </div>

        <div class="upload-container" id="drop-zone">
            <div class="upload-icon"><img src="/static/icons/upload.svg" style="width: 64px; height: 64px;"></div>
            <h2>Drop your N42 or CSV file here</h2>
            <p>or click to browse</p>
            <input type="file" id="file-input" accept=".n42,.xml,.csv">
        </div>

        <div id="dashboard" style="display: none;">
            <div class="metadata-panel" id="metadata-panel">
                <!-- Populated by JS -->
            </div>

            <div class="controls">
                <button id="btn-lin" class="active">Linear</button>
                <button id="btn-log">Logarithmic</button>
                <button id="btn-reset-zoom">Reset Zoom</button>
                <button id="btn-auto-scale" class="active"
                    title="Toggle between Auto-Scale (zoom to data) and Full Spectrum view">Auto-Scale</button>
                <button id="btn-export-json">Export JSON</button>
                <button id="btn-export-csv">Export CSV</button>
                <button id="btn-export-pdf" style="background-color: var(--accent-color); color: white;"><img
                        src="/static/icons/pdf.svg" class="icon"> Export
                    PDF</button>
                <button id="btn-compare" title="Compare Mode"><img src="/static/icons/compare.svg" class="icon">
                    Compare</button>
                <button id="btn-analysis" title="Advanced Analysis"><img src="/static/icons/analysis.svg" class="icon">
                    Analysis</button>
            </div>

            <div id="compare-panel" style="display: none;" class="compare-panel">
                <strong>Comparison Mode:</strong>
                <span id="overlay-count">0 spectra loaded</span>
                <button id="btn-add-file">+ Add Spectrum</button>
                <button id="btn-clear-overlays">Clear All</button>
                <input type="file" id="compare-file-input" accept=".n42,.xml,.csv" style="display:none;">
            </div>

            <div id="analysis-panel" style="display: none;" class="compare-panel">
                <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                    <strong>Spectral Analysis</strong>
                    <div style="display: flex; gap: 8px;">
                        <button id="btn-ml-identify" class="btn-primary"
                            style="padding: 4px 12px; font-size: 0.8rem;"><img src="/static/icons/robot.svg"
                                class="icon" style="margin-right: 0.25rem;">AI Identify</button>
                        <button id="btn-run-fit" class="btn-primary" style="padding: 4px 8px; font-size: 0.8rem;">Run
                            Peak
                            Fitting</button>
                    </div>
                </div>
                <div id="analysis-results" style="margin-top: 10px; width: 100%; overflow-x: auto;">
                    <p style="color: #94a3b8; font-size: 0.9rem;">Click "Run Peak Fitting" to calculate FWHM and Net
                        Area.</p>
                </div>

                <div style="margin-top: 1rem; border-top: 1px solid var(--border-color); padding-top: 1rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <strong>Calibration</strong>
                    </div>
                    <div style="margin-top: 0.5rem;">
                        <button id="btn-calibrate-mode" style="font-size: 0.85rem; padding: 4px 8px;">Open Calibration
                            Tool</button>
                    </div>
                </div>

                <div style="margin-top: 1rem; border-top: 1px solid var(--border-color); padding-top: 1rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <strong>Background Subtraction</strong>
                        <span id="bg-active-indicator"
                            style="display:none; color: var(--accent-color); font-size: 0.8rem; font-weight: bold;">●
                            Active</span>
                    </div>
                    <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem; flex-wrap: wrap;">
                        <button id="btn-load-bg" style="font-size: 0.85rem; padding: 4px 8px;">Load Background
                            File</button>
                        <button id="btn-set-current-bg" style="font-size: 0.85rem; padding: 4px 8px;">Use Current as
                            BG</button>
                        <button id="btn-clear-bg"
                            style="font-size: 0.85rem; padding: 4px 8px; background: #ef4444; color: white; border: none; display:none;">Clear
                            BG</button>
                    </div>
                    <div id="bg-status"
                        style="margin-top: 0.5rem; font-size: 0.8rem; color: var(--text-secondary); font-style: italic;">
                        No background loaded.
                    </div>
                    <input type="file" id="bg-file-input" accept=".n42,.xml,.csv" style="display:none;">
                </div>
            </div>

            <div class="chart-container">
                <canvas id="spectrumChart"></canvas>
            </div>

            <div id="peaks-container" style="display: none;">
                <h3>Detected Peaks</h3>
                <table id="peaks-table">
                    <thead>
                        <tr>
                            <th>Energy (keV)</th>
                            <th>Counts</th>
                        </tr>
                    </thead>
                    <tbody id="peaks-tbody"></tbody>
                </table>
            </div>

            <div id="isotopes-container" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h3 style="margin: 0;"><img src="/static/icons/analysis.svg" class="icon"> Isotope Identification
                    </h3>
                    <div style="display: flex; gap: 0.5rem;">
                        <button id="btn-run-ml" class="btn-primary"
                            style="padding: 6px 12px; font-size: 0.85rem; display: flex; align-items: center; gap: 4px;">
                            <img src="/static/icons/robot.svg" class="icon" style="margin-right: 0.25rem;">AI
                            Identify
                        </button>
                    </div>
                </div>

                <!-- Dual Detection Results -->
                <div id="identification-results" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">

                    <!-- Legacy Peak-Based Results -->
                    <div class="detection-panel"
                        style="background: var(--card-bg); border-radius: 10px; padding: 1rem; border: 1px solid var(--border-color);">
                        <div
                            style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--border-color);">
                            <img src="/static/icons/chart.svg" class="icon" style="margin-right: 0.25rem;">
                            <strong style="color: var(--text-primary);">Peak Matching</strong>
                            <span
                                style="font-size: 0.75rem; color: var(--text-secondary); margin-left: auto;">Legacy</span>
                        </div>
                        <div id="legacy-isotopes-list">
                            <!-- Populated by JS -->
                        </div>
                    </div>

                    <!-- ML-Based Results -->
                    <div class="detection-panel"
                        style="background: linear-gradient(135deg, rgba(56, 189, 248, 0.1), rgba(139, 92, 246, 0.1)); border-radius: 10px; padding: 1rem; border: 1px solid var(--accent-color);">
                        <div
                            style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--accent-color);">
                            <img src="/static/icons/robot.svg" class="icon" style="margin-right: 0.25rem;">
                            <strong style="color: var(--accent-color);">AI Identification</strong>
                            <span style="font-size: 0.75rem; color: var(--text-secondary); margin-left: auto;">PyRIID
                                ML</span>
                        </div>
                        <div id="ml-isotopes-list">
                            <p style="color: var(--text-secondary); font-size: 0.875rem; font-style: italic;">Click "AI
                                Identify" to run ML classification</p>
                        </div>
                    </div>
                </div>

                <!-- Info Bar -->
                <div
                    style="margin-top: 1rem; padding: 0.75rem; background: rgba(56, 189, 248, 0.1); border-radius: 8px; font-size: 0.8rem; color: var(--text-secondary);">
                    <strong><img src="/static/icons/lightbulb.svg" class="icon"
                            style="margin-right: 0.25rem; vertical-align: middle;">Tip:</strong> Peak Matching uses
                    known gamma energies
                    from IAEA/NNDC databases. AI
                    Identification uses a neural network trained on 90+ isotopes for pattern recognition.
                </div>
            </div>

            <div id="decay-chains-container" style="display: none; margin-top: 2rem;">
                <h3><img src="/static/icons/analysis.svg" class="icon"> Decay Chains Detected</h3>
                <div id="decay-chains-list">
                    <!-- Populated by JS -->
                </div>
            </div>

            <!-- ROI Analysis Panel (Advanced Mode Only) -->
            <div id="roi-analysis-panel" style="display: none;">
                <h3><img src="/static/icons/analysis.svg" class="icon"> Region-of-Interest (ROI) Analysis</h3>

                <!-- Configuration Row -->
                <div class="roi-config-row"
                    style="display: flex; flex-wrap: wrap; gap: 1rem; align-items: center; padding: 1rem; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 1rem;">
                    <label style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem;">
                        Detector:
                        <select id="roi-detector">
                            <option value="AlphaHound CsI(Tl)">CsI(Tl) 1.1cm³ (48 cps/μSv/h)</option>
                            <option value="AlphaHound BGO">BGO 0.6cm³ (42 cps/μSv/h)</option>
                        </select>
                    </label>

                    <label style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem;">
                        Acq. Time (s):
                        <input type="number" id="roi-acq-time" value="600" min="1" max="86400" style="width: 80px;">
                    </label>

                    <label style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem;">
                        Isotope:
                        <select id="roi-isotope">
                            <option value="U-235 (186 keV)">U-235 (186 keV)</option>
                            <option value="Th-234 (93 keV)">Th-234 (93 keV)</option>
                            <option value="Cs-137 (662 keV)">Cs-137 (662 keV)</option>
                            <option value="Co-60 (1173 keV)">Co-60 (1173 keV)</option>
                            <option value="Co-60 (1332 keV)">Co-60 (1332 keV)</option>
                            <option value="K-40 (1461 keV)">K-40 (1461 keV)</option>
                            <option value="Bi-214 (609 keV)">Bi-214 (609 keV)</option>
                            <option value="Tl-208 (2614 keV)">Tl-208 (2614 keV)</option>
                            <option value="Am-241 (60 keV)">Am-241 (60 keV)</option>
                        </select>
                    </label>

                    <button id="btn-analyze-roi" class="btn-primary" style="padding: 0.5rem 1rem;">Analyze ROI</button>
                    <button id="btn-highlight-roi" class="btn-secondary"
                        style="padding: 0.5rem 1rem;">Highlight</button>
                    <button id="btn-clear-highlight" class="btn-secondary" style="padding: 0.5rem 1rem;">Clear</button>
                </div>

                <!-- Results Section -->
                <div id="roi-results"
                    style="padding: 1rem; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; font-family: 'Roboto Mono', monospace; font-size: 0.85rem; line-height: 1.8; min-height: 100px;">
                    <p style="color: var(--text-secondary); font-style: italic;">Select an isotope and click "Analyze
                        ROI" to calculate activity.</p>
                </div>
            </div>
        </div>

        <!-- File History Modal -->
        <div id="history-modal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>File History</h3>
                    <button id="close-history" class="close-btn">✕</button>
                </div>
                <div id="history-list"></div>
            </div>
        </div>

        <!-- Settings Modal -->
        <div id="settings-modal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3><img src="/static/icons/settings.svg" class="icon"> Analysis Settings</h3>
                    <button id="close-settings" class="close-btn">✕</button>
                </div>

                <div style="margin: 1.5rem 0;">
                    <h4 style="margin-bottom: 1rem;">Detection Mode</h4>
                    <div style="display: flex; gap: 1rem;">
                        <label
                            style="cursor: pointer; padding: 0.5rem 1rem; border: 2px solid var(--border-color); border-radius: 6px; transition: all 0.3s;">
                            <input type="radio" name="analysis-mode" value="simple" checked
                                style="margin-right: 0.5rem;">
                            <strong>Simple Mode</strong> (Recommended)
                        </label>
                        <label
                            style="cursor: pointer; padding: 0.5rem 1rem; border: 2px solid var(--border-color); border-radius: 6px; transition: all 0.3s;">
                            <input type="radio" name="analysis-mode" value="advanced" style="margin-right: 0.5rem;">
                            <strong>Advanced Mode</strong> (Customizable)
                        </label>
                    </div>
                    <p style="margin-top: 0.5rem; color: var(--text-secondary); font-size: 0.875rem;">Simple mode uses
                        optimized defaults for hobby-level sources.</p>
                </div>

                <div id="advanced-settings"
                    style="display: none; margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color);">
                    <h4 style="margin-bottom: 1rem;">Detection Thresholds</h4>

                    <div style="margin-bottom: 1.5rem;">
                        <label
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <span>Isotope Min Confidence:</span>
                            <strong><span id="iso-conf-val">40</span>%</strong>
                        </label>
                        <input type="range" id="isotope-confidence" min="10" max="90" value="40" step="5"
                            style="width: 100%;">
                        <p style="color: var(--text-secondary); font-size: 0.75rem; margin-top: 0.25rem;">Minimum % of
                            characteristic peaks required to report an isotope</p>
                    </div>

                    <div style="margin-bottom: 1.5rem;">
                        <label
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <span>Chain Min Confidence:</span>
                            <strong><span id="chain-conf-val">30</span>%</strong>
                        </label>
                        <input type="range" id="chain-confidence" min="10" max="90" value="30" step="5"
                            style="width: 100%;">
                        <p style="color: var(--text-secondary); font-size: 0.75rem; margin-top: 0.25rem;">Minimum
                            confidence to report a decay chain</p>
                    </div>

                    <div style="margin-bottom: 1.5rem;">
                        <label
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <span>Energy Tolerance:</span>
                            <strong><span id="energy-tol-val">20</span> keV</strong>
                        </label>
                        <input type="range" id="energy-tolerance" min="5" max="50" value="20" step="1"
                            style="width: 100%;">
                        <p style="color: var(--text-secondary); font-size: 0.75rem; margin-top: 0.25rem;">Maximum energy
                            difference for peak matching</p>
                    </div>

                    <button id="btn-reset-defaults"
                        style="padding: 0.5rem 1rem; border-radius: 6px; margin-right: 0.5rem;">Reset to
                        Defaults</button>
                </div>

                <div
                    style="text-align: right; margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color); display:flex; justify-content:space-between; align-items:center;">
                    <button id="btn-manage-isotopes"
                        style="background:transparent; border:1px solid var(--border-color); color:var(--text-primary);">Manage
                        Custom Isotopes</button>
                    <button id="btn-apply-settings" class="btn-primary">Apply Settings</button>
                </div>
            </div>
        </div>


        <!-- Calibration Modal -->
        <div id="calibration-modal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Energy Calibration</h3>
                    <button id="close-calibration" class="close-btn">✕</button>
                </div>
                <div style="margin: 1rem 0;">
                    <p>Click on the chart to add points (Channel), then enter the known energy.</p>
                    <table style="width: 100%; text-align: left; margin-bottom: 1rem;">
                        <thead>
                            <tr>
                                <th>Channel</th>
                                <th>Energy (keV)</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="cal-points-tbody"></tbody>
                    </table>
                    <div id="cal-results"
                        style="display:none; background: #f0fdf4; padding: 0.5rem; border-radius: 6px; margin-bottom: 1rem; border: 1px solid #86efac;">
                        <strong>Fit Results:</strong><br>
                        Slope: <span id="cal-slope"></span><br>
                        Intercept: <span id="cal-intercept"></span>
                    </div>
                    <div style="text-align: right;">
                        <button id="btn-cal-calculate">Calculate Fit</button>
                        <button id="btn-cal-apply" class="btn-primary" style="display:none;">Apply to View</button>
                    </div>
                </div>
            </div>
        </div>
        <!-- Custom Isotopes Modal -->
        <div id="isotopes-modal" class="modal" style="display: none; z-index: 1001;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Custom Isotopes</h3>
                    <button id="close-isotopes" class="close-btn">✕</button>
                </div>
                <div style="margin: 1rem 0;">
                    <form id="add-isotope-form"
                        style="display:flex; gap:10px; margin-bottom:1rem; align-items:flex-end;">
                        <div style="flex:1;">
                            <label style="font-size:0.8rem; color:var(--text-secondary);">Name (e.g. MySource)</label>
                            <input type="text" id="iso-name" placeholder="Name" required style="width:100%;">
                        </div>
                        <div style="flex:2;">
                            <label style="font-size:0.8rem; color:var(--text-secondary);">Energies (keV,
                                comma-sep)</label>
                            <input type="text" id="iso-energies" placeholder="e.g. 662, 32" required
                                style="width:100%;">
                        </div>
                        <button type="submit" class="btn-primary" style="padding:6px 12px;">Add</button>
                    </form>

                    <h4 style="border-bottom:1px solid var(--border-color); padding-bottom:5px; margin-bottom:10px;">
                        Your Isotopes</h4>
                    <div id="custom-isotopes-list" style="max-height: 200px; overflow-y: auto;"></div>
                </div>
            </div>
        </div>

    </main>

    <!-- Main Application Logic (ES6 Modules) -->
    <script type="module" src="/static/js/main.js?v=2.1"></script>
</body>

</html>